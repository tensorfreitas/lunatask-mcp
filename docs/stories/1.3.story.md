# Story 1.3: Configuration Handling

## Status
Draft

## Story
**As a** developer,
**I want** the server to support configuration via both a file and command-line arguments,
**so that** users can easily and flexibly manage settings like API tokens and ports.

## Acceptance Criteria
1. The server can parse command-line arguments (e.g., `--config-file`, `--port`).
2. The server can read settings from a specified configuration file (e.g., `config.toml`).
3. Command-line arguments take precedence over settings in the configuration file.
4. The server has a default configuration that is used if no file or arguments are provided.
5. The configuration supports, at a minimum, a placeholder for the LunaTask API token.
6. On startup, the server validates configuration and fails fast with a non-zero exit code on critical configuration errors; an error is logged to stderr without exposing secrets.
7. On startup, the server logs an "effective configuration" summary to stderr with secrets redacted.
8. If `--config-file` is not provided, the server attempts to load a default `./config.toml`; a missing file is not an error if defaults suffice.
9. Validation rules:
   - `port` is an integer in the range [1, 65535]
   - `lunatask_base_url` is a valid absolute HTTPS URL
   - `log_level` is one of: `DEBUG`, `INFO`, `WARNING`, `ERROR`, `CRITICAL`
10. Unknown keys in the TOML configuration file are rejected with a clear stderr message and a non-zero exit.

## Tasks / Subtasks
- [ ] Task 1: Create configuration data models using Pydantic (AC: 2, 4, 5, 6, 7, 9, 10)
  - [ ] Subtask 1.1: Create `src/lunatask_mcp/config.py` with ServerConfig BaseModel
  - [ ] Subtask 1.2: Define configuration fields including `lunatask_bearer_token`, `lunatask_base_url`, `port`, `log_level`, and `config_file`
  - [ ] Subtask 1.3: Set default values for all configuration options
  - [ ] Subtask 1.4: Add validation for required fields and data types
  - [ ] Subtask 1.5: Enforce validation rules (`port` range 1–65535; `lunatask_base_url` absolute HTTPS URL; `log_level` whitelist)
  - [ ] Subtask 1.6: Implement a redaction-safe representation (e.g., `to_redacted_dict()`) for logging effective configuration
- [ ] Task 2: Implement command-line argument parsing (AC: 1, 3, 6)
  - [ ] Subtask 2.1: Add argparse configuration to `main.py` for config file, port, and log level options
  - [ ] Subtask 2.2: Create argument parser with `--config-file` and `--port` options (and `--log-level` if present in schema)
  - [ ] Subtask 2.3: Implement precedence logic where CLI args override file settings
  - [ ] Subtask 2.4: Ensure CLI parsing occurs before CoreServer construction in `main()`
  - [ ] Subtask 2.5: Exit with non-zero status on configuration parsing/validation errors
- [ ] Task 3: Implement configuration file loading (AC: 2, 3, 6, 8, 10)
  - [ ] Subtask 3.1: Add TOML file parsing capability using built-in `tomllib`
  - [ ] Subtask 3.2: Create configuration loading function that merges defaults, file, then CLI (CLI > file > defaults)
  - [ ] Subtask 3.3: Handle missing configuration file gracefully with defaults
  - [ ] Subtask 3.4: Implement discovery of `./config.toml` when `--config-file` is not provided
  - [ ] Subtask 3.5: Reject unknown keys with a clear stderr message and non-zero exit
- [ ] Task 4: Integrate configuration into CoreServer (AC: 4, 5, 6, 7)
  - [ ] Subtask 4.1: Update CoreServer class to accept and use configuration
  - [ ] Subtask 4.2: Update `main()` function to load configuration before server start
  - [ ] Subtask 4.3: Ensure bearer token is accessible for future LunaTask API integration
  - [ ] Subtask 4.4: Apply `log_level` from configuration before FastMCP initialization
  - [ ] Subtask 4.5: Wire configuration to downstream components via dependency injection (future `LunaTaskClient`)
- [ ] Task 5: Add comprehensive error handling (AC: 4, 6, 10)
  - [ ] Subtask 5.1: Handle invalid TOML files with clear error messages to stderr
  - [ ] Subtask 5.2: Validate configuration on startup with fail-fast behavior
  - [ ] Subtask 5.3: Ensure bearer token is never exposed in logs or error messages (redaction)
  - [ ] Subtask 5.4: Define and document deterministic exit codes for configuration-related failures
- [ ] Task 6: Create configuration tests following TDD methodology (AC: 1–10)
  - [ ] Subtask 6.1: Unit tests for ServerConfig model validation
  - [ ] Subtask 6.2: Tests for configuration loading with combinations of defaults, file, and CLI (precedence)
  - [ ] Subtask 6.3: Integration tests for CoreServer configuration usage, including `log_level` application
  - [ ] Subtask 6.4: Error scenario tests: invalid TOML, missing values, invalid URL, bad port, bad log level
  - [ ] Subtask 6.5: Test unknown keys behavior (rejection with clear stderr and non-zero exit)
  - [ ] Subtask 6.6: Test discovery fallback when `--config-file` is omitted (`./config.toml`)
  - [ ] Subtask 6.7: Verify “effective configuration” logging to stderr with secrets redacted
  - [ ] Subtask 6.8: Verify non-zero exit codes for configuration failures
- [ ] Task 7: Documentation deliverables (AC: 7, 8)
  - [ ] Subtask 7.1: Add `config.example.toml` illustrating all fields and defaults with comments
  - [ ] Subtask 7.2: Update `README.md` with a “Configuration” section covering CLI usage, precedence, defaults, and TOML example
  - [ ] Subtask 7.3: Document unknown keys behavior and secret redaction policy
  - [ ] Subtask 7.4: Note that `port` is for future HTTP transport and not used by current stdio runtime

## Dev Notes

### Previous Story Insights
- CoreServer class exists in `src/lunatask_mcp/main.py` as main application runner [Source: Story 1.2 completion notes]
- FastMCP server instance already configured with stdio transport and logging to stderr [Source: Story 1.2 completion notes]
- Project structure established with `src/lunatask_mcp/` layout and all dependencies installed [Source: Stories 1.1, 1.2 completion notes]

### Source Tree
- Configuration module should be `src/lunatask_mcp/config.py` according to project structure [Source: architecture/8-source-tree.md]
- Main application entry point is `src/lunatask_mcp/main.py` containing CoreServer class [Source: architecture/8-source-tree.md]
- Tests must be in top-level `tests/` directory with `test_*.py` pattern [Source: architecture/8-source-tree.md]

### Tech Stack
- **Configuration Management**: `pydantic` for data validation & settings management - provides robust, typed configuration from files/env vars, integrates seamlessly with fastmcp [Source: architecture/3-tech-stack.md]
- **Python**: ~3.12 compatibility required [Source: architecture/3-tech-stack.md]
- **TOML Parsing**: Built-in `tomllib` (Python 3.11+) for configuration file parsing
- **CLI Argument Parsing**: Built-in `argparse` module for command-line argument handling

### Architecture Patterns
- **Dependency Injection**: Configuration will be initialized once and made available to CoreServer and other components [Source: architecture/2-high-level-architecture.md]
- **Fail-Fast on Startup**: Server must validate configuration on startup and fail immediately with clear stderr message if critical settings missing [Source: architecture/10-error-handling-strategy.md]

### Component Specifications
- **CoreServer (Application Runner)**: Main entry point responsible for handling configuration loading from files and command-line arguments [Source: architecture/5-components.md]
- Configuration loading must happen before FastMCP initialization to ensure proper server setup [Source: architecture/5-components.md]

### File Locations
- Configuration module: `src/lunatask_mcp/config.py` [Source: architecture/8-source-tree.md]
- Main application: `src/lunatask_mcp/main.py` [Source: architecture/8-source-tree.md]
- Test files: `tests/test_config.py` for configuration tests [Source: architecture/8-source-tree.md]

### Configuration Requirements
- **LunaTask API Token**: Configuration must include placeholder for bearer token used for LunaTask API authentication [Source: Epic 1.3 requirements, architecture/6-external-apis.md]
- **Base URL**: LunaTask API base URL is `https://api.lunatask.app/v1/` [Source: architecture/6-external-apis.md]
- **Port Configuration**: Support for configurable port for future HTTP transport support
- **Security**: Bearer token must never be included in logs or error messages [Source: architecture/10-error-handling-strategy.md, architecture/11-coding-standards.md]

### Logging Standards
- **Output Channel**: All logging MUST be directed to `sys.stderr` to prevent corrupting stdout JSON-RPC channel [Source: architecture/10-error-handling-strategy.md]
- **Security**: The LunaTask bearer token will never be written to logs [Source: architecture/10-error-handling-strategy.md]
- **No print() statements**: Forbidden, use configured logger [Source: architecture/11-coding-standards.md]

### Technical Constraints
- **Python 3.12** compatibility required [Source: architecture/11-coding-standards.md]
- **Line length**: Maximum 100 characters enforced by ruff [Source: architecture/11-coding-standards.md]
- **Type hints**: All function signatures must have explicit type hints [Source: architecture/11-coding-standards.md]
- **Docstrings**: Google Python Style Guide format required [Source: architecture/11-coding-standards.md]

### Configuration Schema Design
Based on requirements and architecture, the configuration should include:
- `lunatask_bearer_token: str` - Bearer token for LunaTask API authentication
- `lunatask_base_url: str = "https://api.lunatask.app/v1/"` - API base URL with default
- `port: int = 8080` - Port for future HTTP transport support
- `config_file: Optional[str] = None` - Path to configuration file
- `log_level: str = "INFO"` - Logging level configuration

Validation constraints:
- `port` must be an integer between 1 and 65535
- `lunatask_base_url` must be an absolute HTTPS URL
- `log_level` must be one of: `DEBUG`, `INFO`, `WARNING`, `ERROR`, `CRITICAL`

Redaction behavior for logging:
- When logging the effective configuration, secret fields (e.g., `lunatask_bearer_token`) must be redacted (e.g., replaced with `"***redacted***"`).

### Precedence Rules
1. Command-line arguments (highest priority)
2. Configuration file values
3. Default values (lowest priority)

### Testing
- Test file location: `tests/test_config.py` [Source: architecture/11-coding-standards.md]
- Test standards: TDD methodology required - write tests first, watch fail, implement minimal code, refactor [Source: architecture/11-coding-standards.md]
- Testing frameworks: `pytest` with `pytest-asyncio` plugin for async testing [Source: architecture/3-tech-stack.md]
- Specific testing requirements:
  - Unit tests for Pydantic models (field presence, types, validation rules)
  - Precedence tests: defaults < file < CLI
  - Missing file vs invalid TOML behavior
  - Validation errors: bad port, invalid URL, invalid log level
  - Unknown keys handling (reject with clear stderr and non-zero exit)
  - Discovery fallback when `--config-file` is omitted (`./config.toml`)
  - Effective configuration logging with secret redaction
  - Non-zero exit codes for configuration failures

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-14 | 1.0 | Initial story creation | Bob (Scrum Master) |