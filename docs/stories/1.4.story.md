# Story 1.4: Secure Authentication Handler

## Status
Ready to Develop

## Story
**As a** developer,
**I want** to securely load the LunaTask bearer token from the configuration and use it to make an authenticated test call to the LunaTask API,
**so that** I can confirm the server can successfully communicate with the external API.

## Acceptance Criteria
1. The server loads the LunaTask bearer token from its configuration.
2. The loaded token is never exposed in any logs or standard output.
3. The server uses an HTTP client (like `httpx`) to make a simple, authenticated request to a read-only LunaTask API endpoint (e.g., a user info endpoint).
4. The server correctly handles a successful (e.g., 200 OK) response from the API.
5. The server correctly handles an unsuccessful (e.g., 401 Unauthorized) response and logs an appropriate error to `stderr` without exposing the token.

## Tasks / Subtasks
- [x] Task 1: Create LunaTask API client component (AC: 1, 2, 3)
  - [x] Subtask 1.1: Create `src/lunatask_mcp/api/client.py` with LunaTaskClient class
  - [x] Subtask 1.2: Add initialization with bearer token from configuration
  - [x] Subtask 1.3: Implement secure authentication header handling with token redaction
  - [x] Subtask 1.4: Add async HTTP client setup using httpx
  - [x] Subtask 1.5: Implement authenticated request method with proper error handling
- [ ] Task 2: Implement API connectivity test endpoint (AC: 3, 4, 5)
  - [ ] Subtask 2.1: Identify appropriate read-only LunaTask API endpoint for testing
  - [ ] Subtask 2.2: Create test_connectivity() method in LunaTaskClient
  - [ ] Subtask 2.3: Handle successful API responses (200 OK) appropriately
  - [ ] Subtask 2.4: Handle authentication failures (401 Unauthorized) with secure error logging
  - [ ] Subtask 2.5: Handle other HTTP errors (network issues, 500 errors) gracefully
- [ ] Task 3: Integrate authentication testing into CoreServer (AC: 1, 2)
  - [ ] Subtask 3.1: Add LunaTaskClient initialization to CoreServer using configuration
  - [ ] Subtask 3.2: Add optional connectivity test during server startup
  - [ ] Subtask 3.3: Ensure bearer token is accessed securely from configuration
  - [ ] Subtask 3.4: Implement proper dependency injection for LunaTaskClient
- [ ] Task 4: Create comprehensive error handling and logging (AC: 2, 5)
  - [ ] Subtask 4.1: Create custom exceptions for LunaTask API errors in `src/lunatask_mcp/api/exceptions.py`
  - [ ] Subtask 4.2: Implement secure logging that never exposes bearer tokens
  - [ ] Subtask 4.3: Add specific error handling for network failures and timeouts
  - [ ] Subtask 4.4: Ensure all error messages are logged to stderr only
- [ ] Task 5: Add comprehensive testing following TDD methodology (AC: 1-5)
  - [ ] Subtask 5.1: Create unit tests for LunaTaskClient authentication setup
  - [ ] Subtask 5.2: Create integration tests for API connectivity testing
  - [ ] Subtask 5.3: Create tests for error scenarios (401, network failures, timeouts)
  - [ ] Subtask 5.4: Create tests verifying token security (no exposure in logs/errors)
  - [ ] Subtask 5.5: Create tests for CoreServer integration with LunaTaskClient

## Dev Notes

### Previous Story Insights
- CoreServer class exists in `src/lunatask_mcp/main.py` with configuration integration [Source: Story 1.3 completion notes]
- ServerConfig Pydantic model with `lunatask_bearer_token` field and redaction capabilities [Source: Story 1.3 completion notes]
- Configuration loading with precedence (CLI > file > defaults) already implemented [Source: Story 1.3 completion notes]
- Bearer token redaction via `to_redacted_dict()` method ensures security [Source: Story 1.3 completion notes]

### Source Tree
- API client should be `src/lunatask_mcp/api/client.py` containing LunaTaskClient class [Source: architecture/8-source-tree.md]
- API exceptions module at `src/lunatask_mcp/api/exceptions.py` [Source: architecture/8-source-tree.md]
- Tests must be in top-level `tests/` directory with `test_*.py` pattern [Source: architecture/8-source-tree.md]
- Main application entry point is `src/lunatask_mcp/main.py` [Source: architecture/8-source-tree.md]

### Tech Stack
- **HTTP Client**: `httpx` for async requests to LunaTask API - modern, fully async-capable HTTP client already included as dependency [Source: architecture/3-tech-stack.md]
- **Python**: ~3.12 compatibility required [Source: architecture/3-tech-stack.md]
- **Configuration**: `pydantic` for data validation & settings management [Source: architecture/3-tech-stack.md]
- **Testing**: `pytest` with `pytest-asyncio` for async testing [Source: architecture/3-tech-stack.md]

### Architecture Patterns
- **Dependency Injection**: LunaTaskClient will be initialized with configuration and made available to other components [Source: architecture/2-high-level-architecture.md]
- **Repository Pattern**: LunaTaskClient separates "talking to LunaTask" from MCP tool handling for modularity [Source: architecture/2-high-level-architecture.md]
- **Asynchronous I/O**: All HTTP operations must use async/await with asyncio [Source: architecture/2-high-level-architecture.md]

### LunaTask API Specifications
- **Base URL**: `https://api.lunatask.app/v1/` [Source: architecture/6-external-apis.md]
- **Authentication**: Bearer Token sent in `Authorization` header [Source: architecture/6-external-apis.md]
- **API Documentation**: 
  - Tasks API: https://lunatask.app/api/tasks-api/entity [Source: architecture/6-external-apis.md]
  - Habits API: https://lunatask.app/api/habits-api/track-activity [Source: architecture/6-external-apis.md]
- **Rate Limits**: Undocumented - server must implement conservative rate limiting [Source: architecture/6-external-apis.md]
- **End-to-End Encryption**: Response payloads for GET requests won't contain sensitive fields like `name` or `notes` [Source: architecture/6-external-apis.md]

### File Locations
- API client module: `src/lunatask_mcp/api/client.py` [Source: architecture/8-source-tree.md]
- API exceptions: `src/lunatask_mcp/api/exceptions.py` [Source: architecture/8-source-tree.md]
- Main application: `src/lunatask_mcp/main.py` [Source: architecture/8-source-tree.md]
- Test files: `tests/test_api_client.py` for LunaTaskClient tests [Source: architecture/8-source-tree.md]

### Security Requirements
- **Bearer Token Handling**: Token must never be included in logs or error messages [Source: architecture/10-error-handling-strategy.md, architecture/11-coding-standards.md]
- **Secure Logging**: All logging directed to `sys.stderr` to prevent stdout corruption [Source: architecture/10-error-handling-strategy.md]
- **Authentication Headers**: Bearer token format: `Authorization: Bearer <token>` [Source: architecture/6-external-apis.md]

### Error Handling Strategy
- **Custom Exception Hierarchy**: Define specific exceptions for LunaTask API errors [Source: architecture/10-error-handling-strategy.md]
- **Service Layer Exception Mapping**: LunaTaskClient inspects HTTP status codes and raises appropriate exceptions [Source: architecture/10-error-handling-strategy.md]
- **Fail-Fast Validation**: Server validates configuration on startup [Source: architecture/10-error-handling-strategy.md]
- **Exception Logging**: Unhandled exceptions logged with full traceback to stderr [Source: architecture/10-error-handling-strategy.md]

### Technical Constraints
- **Python 3.12** compatibility required [Source: architecture/11-coding-standards.md]
- **Line length**: Maximum 100 characters enforced by ruff [Source: architecture/11-coding-standards.md]
- **Type hints**: All function signatures must have explicit type hints [Source: architecture/11-coding-standards.md]
- **Docstrings**: Google Python Style Guide format required [Source: architecture/11-coding-standards.md]
- **Async/Await**: All I/O operations must use async/await [Source: architecture/11-coding-standards.md]

### Configuration Integration
Based on Story 1.3 completion, configuration access:
- `ServerConfig` model with `lunatask_bearer_token: str` field
- `lunatask_base_url: str = "https://api.lunatask.app/v1/"` with default
- Configuration available via CoreServer's `get_config()` method for dependency injection
- Bearer token accessible via `get_lunatask_config()` method for API client

### Testing Requirements
- **TDD Methodology**: Write tests first, watch fail, implement minimal code, refactor [Source: architecture/11-coding-standards.md]
- **Test Location**: `tests/test_api_client.py` for LunaTaskClient tests [Source: architecture/11-coding-standards.md]
- **Async Testing**: Use `pytest-asyncio` for testing async HTTP operations [Source: architecture/3-tech-stack.md]
- **Security Testing**: Verify bearer token never appears in logs or error messages
- **Error Scenario Testing**: Test 401 unauthorized, network failures, timeouts, malformed responses

### Connectivity Test Endpoint
For API connectivity testing, recommended endpoints:
- User info endpoint (read-only, minimal data)
- Simple GET request to verify authentication works
- Should be a lightweight operation for startup validation

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-14 | 1.0 | Initial story creation | Bob (Scrum Master) |

## QA Results

### Review Date: 2025-08-14

### Reviewed By: Quinn (Senior Developer QA)

### Story Specification Assessment

**Excellent story specification** - This story is exceptionally well-documented with comprehensive dev notes, clear acceptance criteria, and detailed task breakdowns. The integration with Story 1.3's configuration system is well-planned, and security considerations are properly addressed throughout.

### Architectural Review

**Strong architectural alignment**:
- Proper separation of concerns with dedicated API client module
- Correct use of dependency injection pattern for configuration
- Appropriate async/await patterns for HTTP operations
- Well-planned error handling hierarchy with custom exceptions

### Security Assessment

**Security-first design implemented**:
- ✓ Bearer token redaction in all logs and errors (AC 2, 5)
- ✓ Secure configuration integration from Story 1.3
- ✓ HTTPS-only API communication enforced
- ✓ Proper authentication header handling

### Acceptance Criteria Analysis

All 5 acceptance criteria are **clear, testable, and comprehensive**:
1. **AC1**: Configuration loading - Well-defined with Story 1.3 integration
2. **AC2**: Token security - Explicit about never exposing tokens
3. **AC3**: HTTP client implementation - Clear specification for httpx usage
4. **AC4**: Success handling - Straightforward 200 OK response handling
5. **AC5**: Error handling - Comprehensive 401 and error logging requirements

### Task Alignment Verification

**Excellent task-to-AC mapping**:
- Task 1 → AC 1, 2, 3 (API client creation)
- Task 2 → AC 3, 4, 5 (Connectivity testing)
- Task 3 → AC 1, 2 (CoreServer integration)
- Task 4 → AC 2, 5 (Error handling)
- Task 5 → AC 1-5 (Comprehensive testing)

All tasks properly cover all acceptance criteria with no gaps.

### Technical Recommendations

**Implementation guidance for the developer**:

1. **API Endpoint Selection**:
   - Recommend using `/user` endpoint for connectivity test (minimal data, read-only)
   - Alternative: `/areas` endpoint (lists workspace areas)
   - Document the chosen endpoint in the implementation

2. **HTTP Client Configuration**:
   ```python
   # Recommended httpx client setup
   timeout = httpx.Timeout(10.0, connect=5.0)  # 10s total, 5s connect
   limits = httpx.Limits(max_keepalive_connections=5, max_connections=10)
   ```

3. **Rate Limiting Implementation**:
   - Implement exponential backoff for 429 responses
   - Start with conservative limits (e.g., 10 requests/second)
   - Make rate limits configurable via ServerConfig

4. **Retry Logic**:
   - Implement retry for transient failures (network errors, 5xx responses)
   - Use exponential backoff: 1s, 2s, 4s (max 3 retries)
   - Don't retry on 4xx errors (except 429)

5. **Optional Connectivity Test**:
   ```python
   # Add to ServerConfig
   test_connectivity_on_startup: bool = Field(
       default=False,
       description="Test LunaTask API connectivity during startup"
   )
   ```

6. **Error Context Enhancement**:
   ```python
   class LunaTaskAPIError(Exception):
       def __init__(self, message: str, status_code: int | None = None):
           self.status_code = status_code
           # Never include bearer token in error messages
           super().__init__(message)
   ```

### Dev Notes Review

**Outstanding documentation quality**:
- Comprehensive references to all relevant architecture documents
- Clear file location specifications
- Detailed technical constraints and requirements
- Excellent cross-referencing with previous story implementations

### Testing Strategy Review

**Comprehensive test coverage planned**:
- Unit tests for authentication setup ✓
- Integration tests for API connectivity ✓
- Error scenario coverage (401, network, timeouts) ✓
- Security verification (token redaction) ✓
- TDD methodology requirement ✓

**Additional test scenarios to consider**:
- Rate limit handling (429 responses)
- Partial response handling (incomplete JSON)
- Connection pooling behavior
- Concurrent request handling

### Identified Improvements

Minor enhancements for consideration:

- [ ] Specify exact read-only endpoint for connectivity test
- [ ] Add configurable timeout values to ServerConfig
- [ ] Define rate limiting strategy and configuration
- [ ] Add retry logic specification for transient failures
- [ ] Make connectivity test optional via configuration
- [ ] Consider adding metrics/monitoring hooks for API calls
- [ ] Document expected response structure for chosen test endpoint

### Implementation Checklist for Developer

When implementing this story, ensure:

- [ ] Use httpx.AsyncClient for all HTTP operations
- [ ] Implement proper connection pooling
- [ ] Add request/response logging at DEBUG level (with token redaction)
- [ ] Use custom exceptions for all error scenarios
- [ ] Include request ID or correlation ID in logs if available
- [ ] Test with both valid and invalid bearer tokens
- [ ] Verify behavior with network interruptions
- [ ] Ensure graceful degradation when API is unavailable

### Final Status

**✓ Story Approved for Development**

This story specification is **ready for implementation**. The requirements are clear, comprehensive, and well-aligned with the project architecture. The developer has excellent guidance through the dev notes and this review.

**Recommendation**: Consider implementing the suggested enhancements (optional connectivity test, rate limiting, retry logic) to create a more robust API client that handles real-world scenarios gracefully.

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References
None

### Completion Notes
- **Task 1 Completed**: Created comprehensive LunaTask API client component
- **API Client Implementation**: Created `src/lunatask_mcp/api/client.py` with LunaTaskClient class following all acceptance criteria
- **Secure Token Handling**: Implemented bearer token redaction in all string representations, headers logging, and error messages
- **HTTP Client Setup**: Configured httpx with proper timeouts (5s connect, 10s read/write/pool) and connection limits
- **Authentication**: Implemented Bearer token authentication headers with proper format
- **Error Handling**: Created custom exception hierarchy in `src/lunatask_mcp/api/exceptions.py` with comprehensive HTTP status code mapping
- **Connectivity Testing**: Implemented `test_connectivity()` method using `/ping` endpoint
- **Async Support**: Full async/await implementation with proper resource cleanup via context manager
- **Security Compliance**: All logs directed to stderr, no token exposure anywhere in the codebase
- **Test Coverage**: Created comprehensive test suite with 21 tests covering all functionality and security requirements

### File List
#### New Files Created
- `src/lunatask_mcp/api/__init__.py` - API module initialization
- `src/lunatask_mcp/api/exceptions.py` - Custom exception hierarchy for LunaTask API errors
- `src/lunatask_mcp/api/client.py` - LunaTaskClient implementation with secure authentication
- `tests/test_api_client.py` - Comprehensive test suite for API client

#### Modified Files
None

### Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-15 | 1.1 | Task 1 completed - LunaTask API client component implemented | James (Dev Agent) |