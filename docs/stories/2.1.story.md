# Story 2.1: Retrieve All Tasks Resource

## Status
Ready for implementation

## Story
**As a** user,
**I want** to retrieve a list of all my tasks via an MCP resource,
**so that** my AI tools can have context on my existing to-dos.

## Acceptance Criteria
1. An MCP resource with URI `lunatask://tasks` is implemented and discoverable via `list_resources`.
2. The resource invokes an authenticated `GET /v1/tasks` to the LunaTask API using the configured Bearer token.
3. On success, returns a JSON-serializable list of task objects conforming to the TaskResponse schema; gracefully handles the absence of encrypted fields (e.g., `name`, `notes`).
4. If the LunaTask API supports pagination and/or filtering for `GET /v1/tasks`, the resource accepts and forwards these parameters; otherwise, the story documents that pagination/filtering are not available.
5. Errors from LunaTask (e.g., 401, 429, 5xx) are mapped to structured MCP errors; all logs go to stderr with token redaction.
6. Requests respect the project's rate limiting configuration.

## Tasks / Subtasks
- [ ] Task 1: Extend LunaTaskClient with get_tasks method (AC: 2, 3, 4, 6)
  - [ ] Subtask 1.1: Implement async `get_tasks() -> List[TaskResponse]` method in LunaTaskClient
  - [ ] Subtask 1.2: Add authenticated GET request to `/v1/tasks` endpoint
  - [ ] Subtask 1.3: Parse response JSON into TaskResponse model list
  - [ ] Subtask 1.4: Handle empty task list responses gracefully
  - [ ] Subtask 1.5: Ensure encrypted fields (name, notes) absence is handled correctly
  - [ ] Subtask 1.6: Wrap the GET `/v1/tasks` call with the project rate limiter
  - [ ] Subtask 1.7: Optionally accept and forward pagination/filter params if documented by the API
- [ ] Task 2: Create TaskTools component with tasks resource (AC: 1, 3, 4, 5)
  - [ ] Subtask 2.1: Create `src/lunatask_mcp/tools/tasks.py` with TaskTools class
  - [ ] Subtask 2.2: Implement MCP resource with URI `lunatask://tasks` using @mcp.resource decorator
  - [ ] Subtask 2.3: Connect resource to `LunaTaskClient.get_tasks()` method
  - [ ] Subtask 2.4: Format task list response as JSON for MCP client consumption
  - [ ] Subtask 2.5: Implement proper error handling and MCP error translation
  - [ ] Subtask 2.6: Ensure resource is registered so `list_resources` returns `lunatask://tasks`
  - [ ] Subtask 2.7: If supported, propagate pagination/filter params to `LunaTaskClient.get_tasks()`
- [ ] Task 3: Integrate TaskTools into CoreServer (AC: 1, 2)
  - [ ] Subtask 3.1: Add TaskTools dependency injection to CoreServer
  - [ ] Subtask 3.2: Register TaskTools with FastMCP instance during server initialization
  - [ ] Subtask 3.3: Ensure LunaTaskClient is available to TaskTools via dependency injection
  - [ ] Subtask 3.4: Test resource registration and availability
  - [ ] Subtask 3.5: Verify resources capability is declared and `lunatask://tasks` is listed during initialize
- [ ] Task 4: Handle LunaTask API errors with structured MCP responses (AC: 5)
  - [ ] Subtask 4.1: Map LunaTask API HTTP errors to appropriate MCP error responses
  - [ ] Subtask 4.2: Implement rate limit error handling (429 responses)
  - [ ] Subtask 4.3: Handle authentication errors (401) with secure error messages
  - [ ] Subtask 4.4: Handle network and server errors (5xx) gracefully
  - [ ] Subtask 4.5: Log all errors to stderr without token exposure
- [ ] Task 5: Add comprehensive testing following TDD methodology (AC: 1-6)
  - [ ] Subtask 5.1: Create unit tests for `LunaTaskClient.get_tasks()` method
  - [ ] Subtask 5.2: Create integration tests for TaskTools resource functionality
  - [ ] Subtask 5.3: Create tests for encrypted field absence handling
  - [ ] Subtask 5.4: Create tests for all error scenarios (401, 429, 5xx, network)
  - [ ] Subtask 5.5: Create tests for CoreServer integration with TaskTools
  - [ ] Subtask 5.6: Verify `list_resources` includes `lunatask://tasks`
  - [ ] Subtask 5.7: Verify rate limiter behavior (no bursts beyond configured limits)
  - [ ] Subtask 5.8: Verify pagination/filter param pass-through (if applicable)

## Dev Notes

### Previous Story Insights
- LunaTaskClient is implemented in `src/lunatask_mcp/api/client.py` with comprehensive authentication and error handling [Source: Story 1.4 completion notes]
- CoreServer in `src/lunatask_mcp/main.py` has dependency injection pattern for LunaTaskClient [Source: Story 1.4 completion notes]
- Complete custom exception hierarchy for all LunaTask API errors (400, 401, 402, 404, 422, 429, 500, 503, 524) [Source: Story 1.4 completion notes]
- Bearer token authentication with secure redaction implemented [Source: Story 1.4 completion notes]
- Async HTTP client with proper timeouts and connection limits configured [Source: Story 1.4 completion notes]

### Data Models
- `TaskResponse` model defines structure for task data received from LunaTask API [Source: architecture/4-data-models.md#taskresponse-response-model]
- Key fields: `id`, `area_id`, `status`, `priority`, `due_date`, `created_at`, `updated_at`, `source`, `tags` [Source: architecture/4-data-models.md#taskresponse-response-model]
- **Critical**: Encrypted fields `name` and `notes` are NOT returned in GET responses due to E2E encryption [Source: architecture/4-data-models.md#taskresponse-response-model]
- `Source` nested model for task source/origin information [Source: architecture/4-data-models.md#source-nested-response-model]
- All models use `pydantic.BaseModel` with runtime type checking [Source: architecture/4-data-models.md]
- If the models module/file is not present, create it as part of this story; encrypted fields should be optional/absent-tolerant

### API Specifications
- **Base URL**: `https://api.lunatask.app/v1/` [Source: architecture/6-external-apis.md#lunatask-api]
- **Endpoint**: `GET /v1/tasks` returns list of user's tasks [Source: architecture/6-external-apis.md#lunatask-api]
- **Authentication**: Bearer Token in `Authorization` header [Source: architecture/6-external-apis.md#lunatask-api]
- **Rate Limits**: Undocumented - conservative rate limiting required [Source: architecture/6-external-apis.md#lunatask-api]
- **E2E Encryption**: Response payloads exclude sensitive fields like `name` and `notes` [Source: architecture/6-external-apis.md#lunatask-api]
- **Pagination/Filtering**: If supported by the Tasks List endpoint, accept and forward parameters; otherwise, document as not available

### Component Architecture
- `LunaTaskClient` service component handles all API communication [Source: architecture/5-components.md#1-lunataskclient-service-component]
- Required method: `async def get_tasks() -> List[TaskResponse]` [Source: architecture/5-components.md#1-lunataskclient-service-component]
- `TaskTools` MCP interface component exposes functionality as resources/tools [Source: architecture/5-components.md#2-tasktools-mcp-interface-component]
- Resources use URI template `lunatask://tasks` for get_tasks [Source: architecture/5-components.md#2-tasktools-mcp-interface-component]
- `CoreServer` handles dependency injection and component registration [Source: architecture/5-components.md#4-coreserver-application-runner]

### File Locations
- LunaTaskClient: `src/lunatask_mcp/api/client.py` (already exists) [Source: architecture/8-source-tree.md]
- TaskTools: `src/lunatask_mcp/tools/tasks.py` (new file to create) [Source: architecture/8-source-tree.md]
- Task models: `src/lunatask_mcp/models/task.py` (create if missing) [Source: architecture/8-source-tree.md]
- Main application: `src/lunatask_mcp/main.py` (existing CoreServer) [Source: architecture/8-source-tree.md]
- Tests: `tests/test_tasks.py` for TaskTools tests [Source: architecture/8-source-tree.md]

### FastMCP Integration Pattern
- Use `@mcp.resource("lunatask://tasks")` decorator for resource definition
- Resource function should be async and return JSON-serializable data
- Resource URI follows template pattern for future parameterization
- Ensure the resource is registered so `list_resources` returns `lunatask://tasks` and the server declares the resources capability
- Error handling should translate LunaTask exceptions to MCP error responses
- Resources are read-only operations, tools are for write operations

### Error Handling Strategy
- Custom exception hierarchy already implemented in `src/lunatask_mcp/api/exceptions.py` [Source: architecture/10-error-handling-strategy.md#custom-exception-definitions]
- Service layer (LunaTaskClient) maps HTTP status codes to custom exceptions [Source: architecture/10-error-handling-strategy.md#service-layer-exception-mapping]
- Tool layer (TaskTools) translates exceptions to MCP error responses [Source: architecture/10-error-handling-strategy.md#tool-layer-translation]
- All logging to `sys.stderr` with no token exposure [Source: architecture/10-error-handling-strategy.md#logging-standards]

### Technical Constraints
- **Python 3.12** compatibility required [Source: architecture/11-coding-standards.md#core-standards]
- **Line length**: Maximum 100 characters enforced by ruff [Source: architecture/11-coding-standards.md#core-standards]
- **Type hints**: All function signatures must have explicit type hints [Source: architecture/11-coding-standards.md#core-standards]
- **Docstrings**: Google Python Style Guide format required [Source: architecture/11-coding-standards.md#core-standards]
- **Async/Await**: All I/O operations must use async/await [Source: architecture/11-coding-standards.md#critical-rules-for-ai-agents]
- **No print()**: Use configured logger to stderr only [Source: architecture/11-coding-standards.md#critical-rules-for-ai-agents]

### MCP Resource Implementation Pattern
- Resources expose data via URI-based access
- Use FastMCP's `@mcp.resource` decorator with URI string
- Resource functions should return JSON-serializable data structures
- Error responses should use structured MCP error format
- Resources are read-only - use tools for write operations

### Testing
- **TDD Methodology**: Write tests first, watch fail, implement minimal code, refactor [Source: architecture/11-coding-standards.md#testing-strategy]
- **Test Location**: `tests/test_tasks.py` for TaskTools tests [Source: architecture/11-coding-standards.md#core-standards]
- **Async Testing**: Use `pytest-asyncio` for testing async operations [Source: architecture/3-tech-stack.md]
- **Mock API Responses**: Test with various response scenarios including empty lists
- **Error Testing**: Verify all exception types are properly handled and translated
- **E2E Encryption Testing**: Ensure graceful handling of missing encrypted fields
- **Resource Discoverability**: Verify `list_resources` includes `lunatask://tasks`
- **Rate Limiter**: Verify no bursts beyond configured limits; simulate sequences to assert throttling
- **Pagination/Filtering**: If supported by the API, verify param pass-through and server behavior

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-19 | 1.1 | Updated AC for resource discoverability, rate limiting, and optional pagination; expanded tasks and testing; updated File Locations/FastMCP notes; changed Status to Ready for Dev | Product Owner |
| 2025-08-19 | 1.0 | Initial story creation | Bob (Scrum Master) |