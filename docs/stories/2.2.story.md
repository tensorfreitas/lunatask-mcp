# Story 2.2: Retrieve a Single Task Resource

## Status
Approved

## Story
**As a** user,
**I want** to retrieve the details of a single task by its ID,
**so that** my AI tools can get information about a specific to-do item.

## Acceptance Criteria
1. An MCP resource is implemented that corresponds to the `GET /v1/tasks/<id>` endpoint.
2. The resource accepts a task `id` as a parameter.
3. A successful response returns the specific task object.
4. The implementation correctly handles the absence of encrypted fields (`name`, `note`, etc.) in the API response.
5. If the task is not found, a specific MCP error is returned.

## Tasks / Subtasks
- [x] Task 1: Extend LunaTaskClient with get_task method using TDD (AC: 1, 3, 4, 5)
  - [x] Subtask 1.1: Write tests for `get_task(task_id: str) -> TaskResponse` method (success, not found, encrypted fields, errors)
  - [x] Subtask 1.2: Watch tests fail - implement async `get_task(task_id: str) -> TaskResponse` method in LunaTaskClient
  - [x] Subtask 1.3: Add authenticated GET request to `/v1/tasks/{task_id}` endpoint with rate limiting
  - [x] Subtask 1.4: Parse response JSON into TaskResponse model instance
  - [x] Subtask 1.5: Handle task not found (404) with specific TaskNotFoundError
  - [x] Subtask 1.6: Refactor - ensure all tests pass and code is clean
- [x] Task 2: Enhance TaskTools with single task resource using TDD (AC: 1, 2, 3, 4, 5)
  - [x] Subtask 2.1: Write tests for MCP resource template `lunatask://tasks/{task_id}` (parameter extraction, success, errors)
  - [x] Subtask 2.2: Watch tests fail - implement MCP resource template with URI `lunatask://tasks/{task_id}` using @mcp.resource decorator
  - [x] Subtask 2.3: Connect resource to `LunaTaskClient.get_task(task_id)` method
  - [x] Subtask 2.4: Format single task response as JSON for MCP client consumption
  - [x] Subtask 2.5: Implement proper error handling including TaskNotFoundError translation
  - [x] Subtask 2.6: Refactor - ensure resource template registration and all tests pass
- [x] Task 3: End-to-End validation testing (AC: 1, 2, 3, 4, 5)
  - [x] Subtask 3.1: Verify resource is discoverable by MCP clients using resource listing
  - [x] Subtask 3.2: Test complete resource access flow from MCP client perspective with valid task_id
  - [x] Subtask 3.3: Validate MCP error responses for TaskNotFoundError and other error scenarios
  - [x] Subtask 3.4: Confirm resource registration and proper URI template matching in running server
- [x] Task 4: Update project documentation (AC: 1, 2)
  - [x] Subtask 4.1: Update README.md with single task resource usage examples
  - [x] Subtask 4.2: Add resource template documentation explaining `lunatask://tasks/{task_id}` pattern
  - [x] Subtask 4.3: Document error scenarios and expected MCP error responses
  - [x] Subtask 4.4: Update API coverage documentation to include GET /v1/tasks/{id} endpoint

## Dev Notes

### Previous Story Insights
- LunaTaskClient is fully implemented in `src/lunatask_mcp/api/client.py` with comprehensive authentication and error handling [Source: Story 2.1 completion notes]
- TaskTools component is established in `src/lunatask_mcp/tools/tasks.py` with successful MCP resource integration patterns [Source: Story 2.1 completion notes]
- Complete custom exception hierarchy for all LunaTask API errors (400, 401, 402, 404, 422, 429, 500, 503, 524) [Source: Story 2.1 completion notes]
- Bearer token authentication with secure redaction implemented [Source: Story 2.1 completion notes]
- Rate limiter integration pattern established using `await self._rate_limiter.acquire()` [Source: Story 2.1 completion notes]
- TDD methodology successfully followed in Story 2.1 with comprehensive test coverage [Source: Story 2.1 completion notes]

### Data Models
- `TaskResponse` model defines structure for individual task data received from LunaTask API [Source: architecture/4-data-models.md#taskresponse-response-model]
- Key fields: `id`, `area_id`, `status`, `priority`, `scheduled_on`, `created_at`, `updated_at`, `source` [Source: architecture/4-data-models.md#taskresponse-response-model]
- **Critical**: Encrypted fields `name` and `note` are NOT returned in GET responses due to E2E encryption [Source: architecture/4-data-models.md#taskresponse-response-model]
- `Source` nested model for task source/origin information [Source: architecture/4-data-models.md#source-nested-response-model]
- All models use `pydantic.BaseModel` with runtime type checking [Source: architecture/4-data-models.md]
- Models are already implemented in `src/lunatask_mcp/api/models.py` from Story 2.1

### API Specifications
- **Base URL**: `https://api.lunatask.app/v1/` [Source: architecture/6-external-apis.md#lunatask-api]
- **Endpoint**: `GET /v1/tasks/{task_id}` returns specific task by ID [Source: architecture/6-external-apis.md#lunatask-api]
- **Authentication**: Bearer Token in `Authorization` header [Source: architecture/6-external-apis.md#lunatask-api]
- **Rate Limits**: Undocumented - conservative rate limiting required [Source: architecture/6-external-apis.md#lunatask-api]
- **E2E Encryption**: Response payloads exclude sensitive fields like `name` and `note` [Source: architecture/6-external-apis.md#lunatask-api]
- **Error Handling**: 404 response when task_id is not found or not accessible

### Component Architecture
- `LunaTaskClient` service component handles all API communication [Source: architecture/5-components.md#1-lunataskclient-service-component]
- Required method: `async def get_task(task_id: str) -> TaskResponse` [Source: architecture/5-components.md#1-lunataskclient-service-component]
- `TaskTools` MCP interface component exposes functionality as resources/tools [Source: architecture/5-components.md#2-tasktools-mcp-interface-component]
- Resources use URI template `lunatask://tasks/{task_id}` for get_task [Source: architecture/5-components.md#2-tasktools-mcp-interface-component]
- `CoreServer` handles dependency injection and component registration [Source: architecture/5-components.md#4-coreserver-application-runner]

### File Locations
- LunaTaskClient: `src/lunatask_mcp/api/client.py` (extend existing) [Source: architecture/8-source-tree.md]
- TaskTools: `src/lunatask_mcp/tools/tasks.py` (extend existing) [Source: architecture/8-source-tree.md]
- Task models: `src/lunatask_mcp/api/models.py` (already exists from Story 2.1) [Source: architecture/8-source-tree.md]
- Tests: `tests/test_api_client.py` and `tests/test_task_tools.py` (extend existing) [Source: architecture/8-source-tree.md]
- Documentation: `README.md` (update with new resource examples) [Source: architecture/8-source-tree.md]

### FastMCP Resource Template Pattern
- Use `@mcp.resource("lunatask://tasks/{task_id}")` decorator for parameterized resource definition
- Resource function should accept `task_id: str` parameter extracted from URI template
- Resource function should be async and return JSON-serializable data
- Resource template pattern allows dynamic parameter extraction from URI [Source: FastMCP research - code examples from gofastmcp.com]
- Error handling should translate LunaTask exceptions to MCP error responses
- Template resources support single path segment parameters `{param}` [Source: FastMCP research - URI template documentation]
- Example pattern: `@mcp.resource("data://{id}") def get_data_by_id(id: str) -> dict:` [Source: FastMCP research - resource template examples]

### Error Handling Strategy
- Custom exception hierarchy already implemented in `src/lunatask_mcp/api/exceptions.py` [Source: architecture/10-error-handling-strategy.md#custom-exception-definitions]
- Service layer (LunaTaskClient) maps HTTP status codes to custom exceptions [Source: architecture/10-error-handling-strategy.md#service-layer-exception-mapping]
- Tool layer (TaskTools) translates exceptions to MCP error responses [Source: architecture/10-error-handling-strategy.md#tool-layer-translation]
- **TaskNotFoundError** for 404 responses when task_id is not found
- All logging to `sys.stderr` with no token exposure [Source: architecture/10-error-handling-strategy.md#logging-standards]

### Technical Constraints
- **Python 3.12** compatibility required [Source: architecture/11-coding-standards.md#core-standards]
- **Line length**: Maximum 100 characters enforced by ruff [Source: architecture/11-coding-standards.md#core-standards]
- **Type hints**: All function signatures must have explicit type hints [Source: architecture/11-coding-standards.md#core-standards]
- **Docstrings**: Google Python Style Guide format required [Source: architecture/11-coding-standards.md#core-standards]
- **Async/Await**: All I/O operations must use async/await [Source: architecture/11-coding-standards.md#critical-rules-for-ai-agents]
- **No print()**: Use configured logger to stderr only [Source: architecture/11-coding-standards.md#critical-rules-for-ai-agents]

### Testing

**TDD Methodology Requirements:**
- **TDD Cycle**: Write tests first, watch fail, implement minimal code, refactor [Source: architecture/11-coding-standards.md#testing-strategy]
- **Test Location**: Extend `tests/test_api_client.py` for LunaTaskClient tests, `tests/test_task_tools.py` for TaskTools tests [Source: architecture/11-coding-standards.md#core-standards]
- **Async Testing**: Use `pytest-asyncio` for testing async operations [Source: architecture/3-tech-stack.md]
- **Mock API Responses**: Test with various response scenarios including task found and not found
- **Error Testing**: Verify all exception types are properly handled and translated, especially TaskNotFoundError
- **E2E Encryption Testing**: Ensure graceful handling of missing encrypted fields
- **Resource Template Testing**: Verify parameter extraction from URI template works correctly
- **Rate Limiter**: Verify rate limiting is applied to single task requests

**Test Scenarios to Implement:**

**LunaTaskClient.get_task() Tests:**
- Success with valid task_id returns TaskResponse
- Task not found (404) raises TaskNotFoundError
- Authentication error (401) raises LunaTaskAuthError
- Rate limit error (429) raises LunaTaskRateLimitError
- Server error (5xx) raises LunaTaskServerError
- Network timeout raises LunaTaskAPIError
- Encrypted fields (name, note) absence handled correctly

**TaskTools Resource Template Tests:**
- Resource template parameter extraction works correctly
- Success scenario returns formatted JSON task data
- TaskNotFoundError translated to MCP error response
- Other errors properly translated to MCP responses
- Resource properly registered with FastMCP
- Parameter validation for invalid task_id formats (empty string, special characters)

**End-to-End Testing:**
- Verify resource is discoverable by MCP clients
- Test complete resource access flow from MCP client perspective
- Validate resource registration and proper URI template matching

### Documentation Requirements
**README.md Updates:**
- Add usage example for single task resource: `lunatask://tasks/{task_id}`
- Document parameter format and expected responses
- Include error scenario examples and MCP error responses
- Update resource listing to show both `lunatask://tasks` and `lunatask://tasks/{task_id}`

**API Coverage Documentation:**
- Document GET /v1/tasks/{id} endpoint implementation
- Note E2E encryption field limitations
- Document error responses and MCP error mapping

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References
- Task 1 implementation: `src/lunatask_mcp/api/client.py:311-339` - get_task method
- Task 1 tests: `tests/test_api_client.py` - TestLunaTaskClientGetTask class (13 comprehensive test cases)
- Task 2 implementation: `src/lunatask_mcp/tools/tasks.py:141-251` - get_task_resource method and resource registration
- Task 2 tests: `tests/test_task_tools.py` - TestSingleTaskResource class (12 comprehensive test cases)
- Task 3 implementation: `tests/test_task_tools.py:941-1283` - TestEndToEndResourceValidation class (8 comprehensive E2E test cases)
- All tests passing: 36/36 TaskTools suite + 50/50 API client suite + 199/199 full suite, no regressions
- Code quality: ruff and pyright checks pass

### Completion Notes
- **Task 1 COMPLETED**: Successfully implemented LunaTaskClient.get_task() method using TDD methodology
- **TDD Process Followed**: Written tests first → watched fail → implemented minimal code → refactored
- **All ACs Met**: AC 1,3,4,5 - method signature, task retrieval, encrypted field handling, 404 error handling
- **Comprehensive Testing**: 13 test cases covering success scenarios, error handling, rate limiting, parsing errors
- **Security Compliance**: No token exposure in logs/errors, proper authentication headers
- **Rate Limiting**: Applied via existing make_request method with TokenBucketLimiter
- **Type Safety**: Full type hints and proper JSON parsing into TaskResponse model
- **Error Handling**: All LunaTask API error scenarios covered with specific exception types

- **Task 2 COMPLETED**: Successfully implemented TaskTools.get_task_resource() MCP resource using TDD methodology
- **All ACs Met**: AC 1,2,3,4,5 - MCP resource template, parameter extraction, JSON response, encrypted field handling, error translation
- **Comprehensive Testing**: 12 test cases covering parameter extraction, success scenarios, all error types, encrypted field handling
- **MCP Integration**: Proper resource template registration with URI pattern `lunatask://tasks/{task_id}`
- **Error Translation**: All LunaTaskClient exceptions properly translated to MCP error responses

- **Task 3 COMPLETED**: Successfully implemented comprehensive End-to-End validation testing using TDD methodology
- **All ACs Met**: AC 1,2,3,4,5 - resource discoverability, complete access flow, error response validation, URI template matching
- **Comprehensive E2E Testing**: 8 test cases covering complete MCP client-to-server flow validation
- **Resource Discoverability**: Validated resource registration and MCP client discovery mechanisms
- **Complete Flow Validation**: End-to-end testing from MCP client perspective with realistic task data
- **Error Response Validation**: Comprehensive testing of TaskNotFoundError, authentication, rate limit error scenarios
- **URI Template Validation**: Confirmed proper parameter extraction and resource registration patterns
- **Encrypted Field Validation**: End-to-end validation that E2E encryption constraints are handled throughout flow

- **Task 4 COMPLETED**: Successfully updated project documentation with comprehensive single task resource information
- **All ACs Met**: AC 1,2 - README usage examples, resource template documentation, error scenarios, API coverage updates
- **README.md Enhancements**: Added complete LunaTask Integration section with resource documentation and usage examples
- **Resource Template Documentation**: Detailed explanation of `lunatask://tasks/{task_id}` URI template pattern
- **Error Scenario Documentation**: Comprehensive coverage of 404, 401, 429 error responses with code examples
- **API Coverage Updates**: Updated `docs/architecture/6-external-apis.md` with GET /v1/tasks/{id} endpoint documentation
- **User-Friendly Examples**: Practical Python code examples for both single and all task resource access
- **Response Format Documentation**: Complete JSON response format examples for both resource types

### File List
Modified files:
- `src/lunatask_mcp/api/client.py` - Added get_task method (lines 311-339)
- `tests/test_api_client.py` - Added TestLunaTaskClientGetTask class with 13 test methods
- `src/lunatask_mcp/tools/tasks.py` - Added get_task_resource method and resource registration (lines 141-251)
- `tests/test_task_tools.py` - Added TestSingleTaskResource class (12 test methods) and TestEndToEndResourceValidation class (8 E2E test methods)
- `README.md` - Added comprehensive LunaTask Integration section with resource documentation, usage examples, and error handling
- `docs/architecture/6-external-apis.md` - Added API Endpoint Coverage section with GET /v1/tasks/{id} documentation
- `docs/stories/2.2.story.md` - Updated all task checkboxes (Tasks 1-4) and added comprehensive Dev Agent Record

## QA Results

### Review Date: 2025-08-21

### Reviewed By: Quinn (Senior Developer & QA Architect)

### Code Quality Assessment
- Clean, senior-level implementation of single-task retrieval:
  - Resource template correctly registered and discoverable via [`TaskTools._register_resources()`](src/lunatask_mcp/tools/tasks.py:45) for:
    - lunatask://tasks
    - lunatask://tasks/{task_id}
  - Async patterns, type hints, and Google-style docstrings are consistently applied in [`LunaTaskClient.get_task()`](src/lunatask_mcp/api/client.py:311) and [`TaskTools.get_task_resource()`](src/lunatask_mcp/tools/tasks.py:146).
- Robust error mapping to custom exceptions with structured MCP responses; coverage validated by:
  - [`TestSingleTaskResource`](tests/test_task_tools.py:520)
  - [`TestLunaTaskClientGetTask`](tests/test_api_client.py:1030)
  - End-to-end validation in [`TestEndToEndResourceValidation`](tests/test_task_tools.py:941)
- Data modeling aligns with encryption constraints using [`TaskResponse`](src/lunatask_mcp/api/models.py:19); absence of encrypted fields (name, note) is handled gracefully.

### Refactoring Performed
No refactoring required.

Optional polish (non-blocking):
1. DRY serialization: Extract a helper to convert [`TaskResponse`](src/lunatask_mcp/api/models.py:19) to dict, shared by [`TaskTools.get_tasks_resource()`](src/lunatask_mcp/tools/tasks.py:50) and [`TaskTools.get_task_resource()`](src/lunatask_mcp/tools/tasks.py:146).
2. Error messages: In unexpected/parse-error branches of [`LunaTaskClient.make_request()`](src/lunatask_mcp/api/client.py:193), [`LunaTaskClient.get_tasks()`](src/lunatask_mcp/api/client.py:271), and [`LunaTaskClient.get_task()`](src/lunatask_mcp/api/client.py:311), enrich messages with safe context (no secrets) to aid triage.
3. Defensive parameter validation (optional): Early-return MCP error for empty task_id at the resource boundary in [`TaskTools.get_task_resource()`](src/lunatask_mcp/tools/tasks.py:146). Current behavior is correct per tests; this would further improve UX clarity.

### Compliance Check
- Coding Standards: ✓ 100-char limit, full type hints, async I/O, stderr logging observed in linked modules.
- Project Structure: ✓ Files in expected locations; resource integrated via FastMCP patterns.
- Testing Strategy: ✓ TDD with comprehensive unit and E2E tests, including URI template extraction and error paths.
- Acceptance Criteria: ✓ AC 1–5 fully satisfied and verified by tests.

### Improvements Checklist
- [x] Extract shared serializer for TaskResponse → dict conversion (remove duplication in TaskTools).
- [x] Enrich unexpected/parse error messages in [`LunaTaskClient.make_request()`](src/lunatask_mcp/api/client.py:193), [`LunaTaskClient.get_tasks()`](src/lunatask_mcp/api/client.py:271), and [`LunaTaskClient.get_task()`](src/lunatask_mcp/api/client.py:311) with safe context.
- [x] Optional: Validate blank task_id at the resource boundary in [`TaskTools.get_task_resource()`](src/lunatask_mcp/tools/tasks.py:146) and emit a clear MCP error.

### Security Review
- Bearer token redaction validated via [`LunaTaskClient._get_redacted_headers()`](src/lunatask_mcp/api/client.py:132); tests confirm no token exposure in error messages.
- Authentication failures use secure, actionable messaging without leaking sensitive data.

### Performance Considerations
- Rate limiting enforced before each request via [`LunaTaskClient.make_request()`](src/lunatask_mcp/api/client.py:225). Operations are lightweight and O(1) for single-resource fetch; no bottlenecks identified.

### Final Status
**✓ Done - All QA improvements implemented and tested**
### Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-20 | 1.0 | Initial story creation with TDD-focused task structure, documentation task, and comprehensive technical context from architecture documents and FastMCP research | Bob (Scrum Master) |
| 2025-08-20 | 1.1 | Story validation and enhancement: Added dedicated Testing subsection, E2E validation task, parameter validation testing, and comprehensive test coverage. Status changed to Approved following validation report. | Sarah (Product Owner) |
| 2025-08-21 | 1.2 | Story implementation completion: Tasks 1-4 fully implemented with TDD methodology. Added comprehensive Dev Agent Record with implementation details, test coverage (36 TaskTools + 199 total tests), and complete documentation updates. All acceptance criteria met. | James (AI Developer) |
| 2025-08-21 | 1.3 | QA Review completed - Approved - Ready for Done | Quinn (Senior Developer QA) |
| 2025-08-21 | 1.4 | QA improvements implemented: Added shared serializer, enhanced error messages with safe context, defensive parameter validation. All 199 tests passing. Story marked Done. | James (AI Developer) |