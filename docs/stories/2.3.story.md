# Story 2.3: Create Task Tool

## Status
Ready for Dev

## Story
**As a** user,
**I want** to create a new task in LunaTask using an MCP tool,
**so that** I can add to-dos from my integrated AI applications.

## Acceptance Criteria
1. An MCP `tool` named `create_task` is implemented, corresponding to `POST /v1/tasks`.
2. The tool accepts all necessary parameters to create a LunaTask task (e.g., `area_id`, `name`, `notes`).
3. A successful API call results in an MCP response containing the ID of the newly created task.

## Tasks / Subtasks
- [x] Task 1: Extend LunaTaskClient with create_task method using TDD (AC: 1, 3)
  - [x] Subtask 1.1: Write tests for `create_task(task_data: TaskCreate) -> TaskResponse` method (success, validation errors, auth errors, rate limits)
  - [x] Subtask 1.2: Watch tests fail - implement async `create_task(task_data: TaskCreate) -> TaskResponse` method in LunaTaskClient
  - [x] Subtask 1.3: Add authenticated POST request to `/v1/tasks` endpoint with JSON payload and rate limiting
  - [x] Subtask 1.4: Parse response JSON into TaskResponse model instance (note: returned task will have assigned ID)
  - [x] Subtask 1.5: Handle validation errors (422) with LunaTaskValidationError
  - [x] Subtask 1.6: Handle subscription limit errors (402) with LunaTaskSubscriptionRequiredError
  - [x] Subtask 1.7: Refactor - ensure all tests pass and code is clean
- [ ] Task 2: Implement create_task MCP tool in TaskTools using TDD (AC: 1, 2, 3)
  - [ ] Subtask 2.1: Write tests for MCP tool `create_task` with various parameter combinations
  - [ ] Subtask 2.2: Watch tests fail - implement MCP tool using @mcp.tool decorator
  - [ ] Subtask 2.3: Define tool parameters matching TaskCreate model fields (name, area_id, priority, etc.)
  - [ ] Subtask 2.4: Convert tool parameters to TaskCreate model instance
  - [ ] Subtask 2.5: Call LunaTaskClient.create_task() and format response
  - [ ] Subtask 2.6: Implement proper error handling with MCP error translation
  - [ ] Subtask 2.7: Refactor - ensure tool registration and all tests pass
- [ ] Task 3: End-to-End validation testing (AC: 1, 2, 3)
  - [ ] Subtask 3.1: Verify tool is discoverable by MCP clients using tool listing
  - [ ] Subtask 3.2: Test complete tool execution flow from MCP client perspective with valid parameters
  - [ ] Subtask 3.3: Validate MCP error responses for validation errors and subscription limits
  - [ ] Subtask 3.4: Confirm tool registration and parameter validation in running server
- [ ] Task 4: Update project documentation (AC: 1, 2)
  - [ ] Subtask 4.1: Update README.md with create_task tool usage examples
  - [ ] Subtask 4.2: Document tool parameters and their types/requirements
  - [ ] Subtask 4.3: Document error scenarios and expected MCP error responses
  - [ ] Subtask 4.4: Update API coverage documentation to include POST /v1/tasks endpoint

## Dev Notes

### Previous Story Insights
- LunaTaskClient fully implemented with comprehensive error handling and rate limiting [Source: Story 2.1 & 2.2 completion notes]
- TaskTools component established with successful MCP resource/tool integration patterns [Source: Story 2.1 & 2.2 completion notes]
- Complete custom exception hierarchy for all LunaTask API errors (400, 401, 402, 404, 422, 429, 500, 503, 524) [Source: Story 2.1 completion notes]
- Bearer token authentication with secure redaction implemented [Source: Story 2.1 completion notes]
- Rate limiter integration pattern established using `await self._rate_limiter.acquire()` [Source: Story 2.1 completion notes]
- TDD methodology successfully followed in Stories 2.1 and 2.2 with comprehensive test coverage [Source: Story 2.1 & 2.2 completion notes]
- Shared serialization helper `_serialize_task_response()` implemented for TaskResponse objects [Source: Story 2.2 QA improvements]

### Data Models
- `TaskCreate` request model already defined for creating new tasks [Source: architecture/4-data-models.md#taskcreate-request-model]
- Required fields: `name` (str) [Source: architecture/4-data-models.md#taskcreate-request-model]
- Optional fields: `notes`, `area_id`, `status` (default: "open"), `priority`, `due_date`, `tags`, `source` [Source: architecture/4-data-models.md#taskcreate-request-model]
- `TaskResponse` model defines structure for task data returned after creation [Source: architecture/4-data-models.md#taskresponse-response-model]
- **Critical**: POST requests CAN include `name` and `notes` fields (they get encrypted client-side) [Source: architecture/4-data-models.md#taskcreate-request-model]
- All models use `pydantic.BaseModel` with runtime type checking [Source: architecture/4-data-models.md]

### API Specifications
- **Base URL**: `https://api.lunatask.app/v1/` [Source: architecture/6-external-apis.md#lunatask-api]
- **Endpoint**: `POST /v1/tasks` creates a new task [Source: architecture/6-external-apis.md#lunatask-api]
- **Authentication**: Bearer Token in `Authorization` header [Source: architecture/6-external-apis.md#lunatask-api]
- **Request Body**: JSON payload with TaskCreate model fields [Source: LunaTask API research]
- **Response**: Returns created task with assigned ID [Source: LunaTask API research]
- **Error Codes**: 
  - 402: Payment Required (free plan limit reached) 
  - 422: Unprocessable Entity (validation error)
  - Other standard errors (401, 429, 500, etc.)

### Component Architecture
- `LunaTaskClient` service component handles all API communication [Source: architecture/5-components.md#1-lunataskclient-service-component]
- Required method: `async def create_task(task_data: TaskCreate) -> TaskResponse` [Source: architecture/5-components.md#1-lunataskclient-service-component]
- `TaskTools` MCP interface component exposes functionality as tools [Source: architecture/5-components.md#2-tasktools-mcp-interface-component]
- Tools use `@mcp.tool` decorator for write operations [Source: architecture/5-components.md#2-tasktools-mcp-interface-component]
- `CoreServer` handles dependency injection and component registration [Source: architecture/5-components.md#4-coreserver-application-runner]

### File Locations
- LunaTaskClient: `src/lunatask_mcp/api/client.py` (extend existing) [Source: architecture/8-source-tree.md]
- TaskTools: `src/lunatask_mcp/tools/tasks.py` (extend existing) [Source: architecture/8-source-tree.md]
- Task models: `src/lunatask_mcp/api/models.py` (TaskCreate model to be added) [Source: architecture/8-source-tree.md]
- Tests: `tests/test_api_client.py` and `tests/test_task_tools.py` (extend existing) [Source: architecture/8-source-tree.md]
- Documentation: `README.md` (update with new tool examples) [Source: architecture/8-source-tree.md]

### FastMCP Tool Pattern
- Use `@mcp.tool` decorator for tool definition [Source: FastMCP research - gofastmcp.com examples]
- Tool function should be async: `async def create_task(ctx: Context, ...) -> dict` [Source: FastMCP research]
- First parameter is always `ctx: Context` for logging and context [Source: FastMCP research]
- Parameters after `ctx` become the tool's input parameters [Source: FastMCP research]
- Return value is automatically serialized to JSON [Source: FastMCP research]
- Tool docstring becomes the tool's description [Source: FastMCP research]
- Example pattern: `@mcp.tool async def my_tool(ctx: Context, param1: str) -> dict:` [Source: FastMCP research]

### Error Handling Strategy
- Custom exception hierarchy already implemented in `src/lunatask_mcp/api/exceptions.py` [Source: architecture/10-error-handling-strategy.md#custom-exception-definitions]
- Service layer (LunaTaskClient) maps HTTP status codes to custom exceptions [Source: architecture/10-error-handling-strategy.md#service-layer-exception-mapping]
- Tool layer (TaskTools) translates exceptions to MCP error responses [Source: architecture/10-error-handling-strategy.md#tool-layer-translation]
- **LunaTaskValidationError** for 422 responses when entity validation fails
- **LunaTaskSubscriptionRequiredError** for 402 responses when free plan limit reached
- All logging to `sys.stderr` with no token exposure [Source: architecture/10-error-handling-strategy.md#logging-standards]

### Technical Constraints
- **Python 3.12** compatibility required [Source: architecture/11-coding-standards.md#core-standards]
- **Line length**: Maximum 100 characters enforced by ruff [Source: architecture/11-coding-standards.md#core-standards]
- **Type hints**: All function signatures must have explicit type hints [Source: architecture/11-coding-standards.md#core-standards]
- **Docstrings**: Google Python Style Guide format required [Source: architecture/11-coding-standards.md#core-standards]
- **Async/Await**: All I/O operations must use async/await [Source: architecture/11-coding-standards.md#critical-rules-for-ai-agents]
- **No print()**: Use configured logger to stderr only [Source: architecture/11-coding-standards.md#critical-rules-for-ai-agents]

### Testing

**TDD Methodology Requirements:**
- **TDD Cycle**: Write tests first, watch fail, implement minimal code, refactor [Source: architecture/11-coding-standards.md#testing-strategy]
- **Test Location**: Extend `tests/test_api_client.py` for LunaTaskClient tests, `tests/test_task_tools.py` for TaskTools tests [Source: architecture/11-coding-standards.md#core-standards]
- **Async Testing**: Use `pytest-asyncio` for testing async operations [Source: architecture/3-tech-stack.md]
- **Mock API Responses**: Test with various response scenarios including success and error cases
- **Error Testing**: Verify all exception types are properly handled and translated
- **Parameter Testing**: Test with various combinations of required and optional parameters
- **Rate Limiter**: Verify rate limiting is applied to POST requests

**Test Scenarios to Implement:**

**LunaTaskClient.create_task() Tests:**
- Success with minimal parameters (name only) returns TaskResponse with ID
- Success with all parameters returns complete TaskResponse
- Validation error (422) raises LunaTaskValidationError
- Subscription limit (402) raises LunaTaskSubscriptionRequiredError
- Authentication error (401) raises LunaTaskAuthenticationError
- Rate limit error (429) raises LunaTaskRateLimitError
- Server error (5xx) raises LunaTaskServerError
- Network timeout raises LunaTaskTimeoutError
- Response parsing with assigned task ID works correctly

**TaskTools create_task Tool Tests:**
- Tool registration with FastMCP works correctly
- Success scenario with minimal parameters returns task ID
- Success scenario with all parameters returns task ID
- Parameter validation for required fields (name)
- Optional parameters handled correctly when omitted
- LunaTaskValidationError translated to MCP error response
- LunaTaskSubscriptionRequiredError translated to MCP error response
- Other errors properly translated to MCP responses
- Tool is discoverable via MCP tool listing

**End-to-End Testing:**
- Verify tool is discoverable by MCP clients
- Test complete tool execution flow from MCP client perspective
- Validate tool parameter schema exposed to MCP clients
- Test error responses are properly formatted for MCP clients

### Documentation Requirements
**README.md Updates:**
- Add usage example for create_task tool
- Document all tool parameters with types and requirements
- Include examples with minimal and full parameter sets
- Document error scenarios and MCP error responses
- Update tool listing to include create_task

**API Coverage Documentation:**
- Document POST /v1/tasks endpoint implementation
- Note that name/notes fields CAN be sent in POST requests
- Document validation and subscription limit error handling

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References
- Task 1 implementation: `src/lunatask_mcp/api/client.py:342-375` - create_task method
- Task 1 tests: `tests/test_api_client.py:1371-1636` - TestLunaTaskClientCreateTask class (10 comprehensive test cases)
- TaskCreate model: `src/lunatask_mcp/api/models.py:40-56` - Request model for task creation
- All tests passing: 60/60 API client suite, no regressions
- Code quality: ruff and pyright checks pass

### Completion Notes
- **Task 1 COMPLETED**: Successfully implemented LunaTaskClient.create_task() method using TDD methodology
- **TDD Process Followed**: Written tests first → watched fail → implemented minimal code → refactored
- **All ACs Met**: AC 1,3 - async create_task method, POST /v1/tasks endpoint, task response with assigned ID
- **Comprehensive Testing**: 10 test cases covering success scenarios, error handling (422, 402, 401, 429, 5xx), rate limiting, response parsing
- **Security Compliance**: No token exposure in logs/errors, proper authentication headers
- **Rate Limiting**: Applied via existing make_request method with TokenBucketLimiter
- **Type Safety**: Full type hints and proper JSON serialization from TaskCreate model
- **Error Handling**: All LunaTask API error scenarios covered with specific exception types (LunaTaskValidationError, LunaTaskSubscriptionRequiredError)
- **Model Integration**: TaskCreate model with proper field defaults and validation
- **API Integration**: Correct usage of make_request with data parameter for JSON payload

### File List
Modified files:
- `src/lunatask_mcp/api/models.py` - Added TaskCreate request model (lines 40-56)
- `src/lunatask_mcp/api/client.py` - Added create_task method and import (lines 26, 342-375)
- `tests/test_api_client.py` - Added TestLunaTaskClientCreateTask class with 10 test methods and import (lines 29, 53, 1371-1636)

## QA Results

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-21 | 1.0 | Initial story creation with comprehensive technical context from architecture documents, previous story insights, and API research | Bob (Scrum Master) |
| 2025-08-21 | 1.1 | Story validation completed: Fixed AC #2 field name (listId → area_id), validation score 9/10, status changed to Ready for Dev | Sarah (Product Owner) |