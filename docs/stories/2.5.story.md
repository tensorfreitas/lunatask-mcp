# Story 2.5: Delete Task Tool

## Status
Draft

## Story
**As a** user,
**I want** to delete a task by its ID using an MCP tool,
**so that** I can clean up completed or unnecessary to-dos.

## Acceptance Criteria
1. An MCP tool named `delete_task` is implemented and corresponds to `DELETE /v1/tasks/{id}`.
2. The tool requires a single input parameter `id` (the task ID to delete).
3. On successful deletion (HTTP 204), the tool returns a JSON object with:
   - `success`: true
   - `message`: "Task deleted successfully"
   - `task_id`: equal to the provided `id`
4. If the task ID does not exist, the tool returns a not found error response translated from the
   service layer.
5. Validation: `id` must be non-empty and not only whitespace; null/None is invalid and must produce
   a tool-layer validation error.
6. Repeated deletion of an already-deleted or non-existent task returns a not found error
   (non-idempotent behavior).
7. Rate limiting applies to DELETE requests; the standard rate limiter used by other client calls
   must be invoked.
8. Documentation is updated with usage example, parameters, and error scenarios, and
   `DELETE /v1/tasks/{id}` is marked as implemented.

## Tasks / Subtasks
- [ ] Task 1: Extend LunaTaskClient with delete_task method using TDD (AC: 1, 3, 4)
  - [ ] Subtask 1.1: Write tests for `delete_task(task_id: str) -> bool` method (success 204, 404 not found, auth errors, rate limits)
  - [ ] Subtask 1.2: Watch tests fail - implement async `delete_task(task_id: str) -> bool` method in LunaTaskClient
  - [ ] Subtask 1.3: Modify `make_request` to handle 204 No Content responses - if `response.status_code == 204`, return `{}` before JSON parsing
  - [ ] Subtask 1.4: Add authenticated DELETE request to `tasks/{id}` endpoint using existing rate limiter via `make_request`
  - [ ] Subtask 1.5: Handle 404 errors with LunaTaskNotFoundError
  - [ ] Subtask 1.6: Handle other errors (401, 429, 5xx) with appropriate custom exceptions
  - [ ] Subtask 1.7: Return `True` strictly for 204 responses, raise mapped exceptions for all other cases
  - [ ] Subtask 1.8: Refactor - ensure all tests pass and code is clean
- [ ] Task 2: Implement delete_task MCP tool in TaskTools using TDD (AC: 1, 2, 3, 4, 5, 6)
  - [ ] Subtask 2.1: Write tests for MCP tool `delete_task` with various scenarios (success, not found, auth errors)
  - [ ] Subtask 2.2: Watch tests fail - register delete_task via FastMCP: add `self.mcp.tool('delete_task')(self.delete_task_tool)` in `_register_resources()`
  - [ ] Subtask 2.3: Define tool with required `id` parameter for task ID
  - [ ] Subtask 2.4: Validate id is not None, not empty, and not whitespace-only (similar to `update_task_tool` validation)
  - [ ] Subtask 2.5: Call LunaTaskClient.delete_task() and on `True`, return `{"success": true, "message": "Task deleted successfully", "task_id": id}`
  - [ ] Subtask 2.6: Return structured success response including task_id for confirmation
  - [ ] Subtask 2.7: Follow existing translation patterns from `update_task_tool` and `create_task_tool` to map exceptions to structured MCP responses
  - [ ] Subtask 2.8: Ensure tool registration in _register_resources() method is complete
  - [ ] Subtask 2.9: Refactor - ensure tool registration and all tests pass
- [ ] Task 3: End-to-End validation testing (AC: 1, 2, 3, 4, 5, 6, 7)
  - [ ] Subtask 3.1: Verify tool is discoverable by MCP clients using tool listing
  - [ ] Subtask 3.2: Test complete tool execution flow from MCP client perspective
  - [ ] Subtask 3.3: Validate MCP error responses for 404 not found errors
  - [ ] Subtask 3.4: Validate MCP error responses for auth and rate limit errors
  - [ ] Subtask 3.5: Confirm rate limiter applies to DELETE requests (verify `acquire()` is called)
  - [ ] Subtask 3.6: Test non-idempotent behavior - second delete attempt on same ID returns not found error (AC: 6)
- [ ] Task 4: Update project documentation (AC: 8)
  - [ ] Subtask 4.1: Update README.md with delete_task tool usage examples
  - [ ] Subtask 4.2: Document tool parameters (just the required task ID)
  - [ ] Subtask 4.3: Document error scenarios and expected MCP error responses
  - [ ] Subtask 4.4: Update API coverage documentation to mark DELETE /v1/tasks/{id} as implemented

## Dev Notes

### Previous Story Insights
- LunaTaskClient fully implemented with comprehensive error handling and rate limiting [Source: Story 2.1-2.4 completion notes]
- TaskTools component established with successful MCP resource/tool integration patterns [Source: Story 2.1-2.4 completion notes]
- Complete custom exception hierarchy including LunaTaskNotFoundError [Source: Story 2.1 completion notes]
- Bearer token authentication with secure redaction implemented [Source: Story 2.1 completion notes]
- Rate limiter integration pattern established using `await self._rate_limiter.acquire()` [Source: Story 2.1 completion notes]
- TDD methodology successfully followed in Stories 2.1-2.4 with comprehensive test coverage [Source: Story 2.1-2.4 completion notes]
- Shared serialization helper `_serialize_task_response()` implemented (not needed for delete) [Source: Story 2.2 QA improvements]
- Established pattern for MCP tool error translation and response formatting [Source: Story 2.3-2.4 completion notes]
- **CRITICAL**: Current `make_request` method calls `response.json()` which will fail on 204 No Content - needs modification [Source: Research findings]

### Data Models
- No request/response models needed for DELETE operation [Source: architecture/4-data-models.md]
- DELETE returns 204 No Content (empty response body) on success [Source: Research findings]
- 404 Not Found indicates task doesn't exist [Source: Research findings]
- Standard error responses: 401 (auth), 429 (rate limit), 5xx (server errors) [Source: architecture/10-error-handling-strategy.md]

### API Specifications
- **Base URL**: `https://api.lunatask.app/v1/` [Source: architecture/6-external-apis.md#lunatask-api]
- **Endpoint**: `DELETE /v1/tasks/{id}` deletes an existing task [Source: architecture/6-external-apis.md#not-yet-implemented]
- **Authentication**: Bearer Token in `Authorization` header [Source: architecture/6-external-apis.md#lunatask-api]
- **Success Response**: 204 No Content with empty body [Source: Epic 2 Story 2.5 AC3]
- **Error Codes**: 
  - 401: Unauthorized (authentication error)
  - 404: Not Found (task doesn't exist)
  - 429: Too Many Requests (rate limit)
  - 5xx: Server errors
  [Source: architecture/6-external-apis.md, Research findings]
- **Rate Limiting**: Applied via TokenBucketLimiter in make_request [Source: architecture/6-external-apis.md#response-format-notes]

### Component Architecture
- `LunaTaskClient` service component handles all API communication [Source: architecture/5-components.md#1-lunataskclient-service-component]
- Original architecture signature: `async def delete_task(task_id: str) -> None` [Source: architecture/5-components.md#1-lunataskclient-service-component]
- **Canonical signature for this story**: `async def delete_task(task_id: str) -> bool` - returns `True` on 204 success for clearer tool layer handling [Source: Review feedback]
- `TaskTools` MCP interface component exposes functionality as tools [Source: architecture/5-components.md#2-tasktools-mcp-interface-component]
- Tools use `@mcp.tool` decorator for write operations [Source: architecture/5-components.md#2-tasktools-mcp-interface-component]
- `CoreServer` handles dependency injection and component registration [Source: architecture/5-components.md#4-coreserver-application-runner]

### File Locations
- LunaTaskClient: `src/lunatask_mcp/api/client.py` (extend existing) [Source: architecture/8-source-tree.md]
- TaskTools: `src/lunatask_mcp/tools/tasks.py` (extend existing) [Source: architecture/8-source-tree.md]
- Tests: `tests/test_api_client.py` and `tests/test_task_tools.py` (extend existing) [Source: architecture/8-source-tree.md]
- E2E Tests: `tests/test_stdio_client_integration.py` (extend existing) [Source: Story 2.3-2.4 file lists]
- Documentation: `README.md` and `docs/architecture/6-external-apis.md` (update) [Source: architecture/8-source-tree.md]

### FastMCP Tool Pattern
- Register tool via FastMCP instance in `_register_resources()` method: `self.mcp.tool('delete_task')(self.delete_task_tool)` [Source: Existing patterns in TaskTools]
- Tool function should be async: `async def delete_task_tool(self, ctx: Context, id: str) -> dict` [Source: Existing tool patterns]
- First parameter is always `ctx: Context` for logging and context [Source: Existing patterns]
- Parameters after `ctx` become the tool's input parameters [Source: Existing patterns]
- Return value is automatically serialized to JSON [Source: FastMCP behavior]
- Tool docstring becomes the tool's description [Source: FastMCP behavior]
- Follow existing tool registration pattern from `create_task_tool` and `update_task_tool` [Source: Review feedback]

### Error Handling Strategy
- Custom exception hierarchy already implemented in `src/lunatask_mcp/api/exceptions.py` [Source: architecture/10-error-handling-strategy.md#custom-exception-definitions]
- Service layer (LunaTaskClient) maps HTTP status codes to custom exceptions [Source: architecture/10-error-handling-strategy.md#service-layer-exception-mapping]
- Tool layer (TaskTools) translates exceptions to MCP error responses [Source: architecture/10-error-handling-strategy.md#tool-layer-translation]
- **LunaTaskNotFoundError** for 404 responses when task doesn't exist [Source: Story 2.1 completion notes]
- All logging to `sys.stderr` with no token or sensitive data exposure [Source: architecture/10-error-handling-strategy.md#logging-standards]

### Technical Constraints
- **Python 3.12** compatibility required [Source: architecture/11-coding-standards.md#core-standards]
- **Line length**: Maximum 100 characters enforced by ruff [Source: architecture/11-coding-standards.md#core-standards]
- **Type hints**: All function signatures must have explicit type hints [Source: architecture/11-coding-standards.md#core-standards]
- **Docstrings**: Google Python Style Guide format required [Source: architecture/11-coding-standards.md#core-standards]
- **Async/Await**: All I/O operations must use async/await [Source: architecture/11-coding-standards.md#critical-rules-for-ai-agents]
- **No print()**: Use configured logger to stderr only [Source: architecture/11-coding-standards.md#critical-rules-for-ai-agents]
- **Security**: Never log bearer tokens or sensitive data [Source: architecture/11-coding-standards.md#critical-rules-for-ai-agents]

### Testing

**TDD Methodology Requirements:**
- **TDD Cycle**: Write tests first, watch fail, implement minimal code, refactor [Source: architecture/11-coding-standards.md#testing-strategy]
- **Test Location**: Extend `tests/test_api_client.py` for LunaTaskClient tests, `tests/test_task_tools.py` for TaskTools tests [Source: architecture/11-coding-standards.md#core-standards]
- **Async Testing**: Use `pytest-asyncio` for testing async operations [Source: architecture/3-tech-stack.md]
- **Mock API Responses**: Test with various response scenarios including success and error cases
- **Error Testing**: Verify all exception types are properly handled and translated
- **Rate Limiter**: Verify rate limiting is applied to DELETE requests

**Test Scenarios to Implement:**

**LunaTaskClient.delete_task() Tests:**
- Success with 204 No Content response returns `True`
- Task not found (404) raises LunaTaskNotFoundError
- Authentication error (401) raises LunaTaskAuthenticationError
- Rate limit error (429) raises LunaTaskRateLimitError
- Server error (5xx) raises LunaTaskServerError
- Network timeout raises LunaTaskTimeoutError
- Empty task_id parameter validation
- Special characters in task_id handled correctly

**TaskTools delete_task Tool Tests:**
- Tool registration with FastMCP works correctly
- Required id parameter enforced
- Success scenario returns `{"success": true, "message": "Task deleted successfully", "task_id": "<id>"}`
- Empty/None id validation error
- LunaTaskNotFoundError translated to MCP error response
- LunaTaskAuthenticationError translated to MCP error response
- Other errors properly translated to MCP responses
- Tool is discoverable via MCP tool listing
- No sensitive data (tokens) in logs

**End-to-End Testing:**
- Verify tool is discoverable by MCP clients
- Test complete tool execution flow from MCP client perspective
- Validate 404 error response formatting for MCP clients
- Validate auth and rate limit error responses
- Verify rate limiter applies to DELETE requests
- Test non-idempotent behavior - second delete attempt on same ID returns not found error

### Implementation Notes

**204 No Content Handling:**
- Modify `make_request` method to check status code before calling `response.json()`
- If `response.status_code == 204`, return `{}` before attempting JSON parsing
- Keep behavior generic without adding special parameters unless needed later
- This is the most critical prerequisite to prevent runtime JSON parsing failures

**Response Format:**
- See Acceptance Criteria (AC3) for the success response schema.
- Include deleted task_id in the success response for confirmation.
- Error responses follow established MCP error translation patterns from existing tools

**Idempotency Decision (Resolved):**
- **Non-idempotent behavior chosen** to align with AC4 and AC6
- Repeated DELETE of non-existent task returns 404 → LunaTaskNotFoundError → MCP error response
- This maintains consistency with the requirement that "An error is returned if the task ID does not exist"
- Second deletion attempt will receive not found error, not success

**Security Considerations:**
- Never log bearer tokens in errors or debug messages
- Use safe error messages for client consumption
- Ensure all error responses are sanitized

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-23 | 1.0 | Initial story creation with comprehensive technical context from architecture docs and research | Bob (Scrum Master) |
| 2025-08-23 | 1.1 | Acceptance Criteria refined; standardized {id}; added rate limiter AC; clarified validation incl. None/null; promoted success schema to AC; aligned Tasks/Subtasks; Response Format references AC3 | PO |

## Dev Agent Record

### Agent Model Used
(To be filled by Dev Agent)

### Debug Log References
(To be filled by Dev Agent)

### Completion Notes
(To be filled by Dev Agent)

### File List
(To be filled by Dev Agent)

## QA Results
(To be filled by QA Agent)