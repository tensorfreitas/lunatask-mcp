# Story 2.6: Implement Rate Limiter

## Status
Done

## Story
**As a** developer,
**I want** all outgoing requests to the LunaTask API to be managed by a configurable in-memory rate limiter,
**so that** the server operates reliably without being blocked.

## Acceptance Criteria
1. A configurable, in-memory rate-limiting mechanism is implemented.
2. All five MCP resources/tools created in this epic use the rate limiter before making an external API call.
3. When a request is rate-limited, the server returns a specific, structured MCP error to the client.

## Tasks / Subtasks
- [x] Task 1: Implement in-memory Token Bucket rate limiter (AC: 1)
  - [x] Subtask 1.1: Create async rate limiter with token bucket algorithm [TokenBucketLimiter()](src/lunatask_mcp/rate_limiter.py:20)
  - [x] Subtask 1.2: Validate configuration parameters (rpm, burst) [InvalidRPMError()](src/lunatask_mcp/rate_limiter.py:12), [InvalidBurstError()](src/lunatask_mcp/rate_limiter.py:16)
  - [x] Subtask 1.3: Support blocking acquire [TokenBucketLimiter.acquire()](src/lunatask_mcp/rate_limiter.py:52) and non-blocking [TokenBucketLimiter.try_acquire()](src/lunatask_mcp/rate_limiter.py:66)
  - [x] Subtask 1.4: Implement token refill at rpm/60 with burst cap [TokenBucketLimiter._refill_tokens()](src/lunatask_mcp/rate_limiter.py:96)
  - [x] Subtask 1.5: Expose configuration via ServerConfig [ServerConfig.rate_limit_rpm](src/lunatask_mcp/config.py:51), [ServerConfig.rate_limit_burst](src/lunatask_mcp/config.py:58)
- [x] Task 2: Integrate limiter into LunaTaskClient before every HTTP request (AC: 2)
  - [x] Subtask 2.1: Instantiate limiter from ServerConfig in client init [LunaTaskClient.__init__()](src/lunatask_mcp/api/client.py:55)
  - [x] Subtask 2.2: Await limiter before sending request [LunaTaskClient.make_request()](src/lunatask_mcp/api/client.py:225)
  - [x] Subtask 2.3: Ensure limiter concurrency safety via async lock [TokenBucketLimiter.__init__()](src/lunatask_mcp/rate_limiter.py:45)
- [x] Task 3: Ensure all MCP resources/tools use client methods (AC: 2)
  - [x] Subtask 3.1: Resources call client GET endpoints [TaskTools.get_tasks_resource()](src/lunatask_mcp/tools/tasks.py:88), [TaskTools.get_task_resource()](src/lunatask_mcp/tools/tasks.py:166)
  - [x] Subtask 3.2: Tools call client POST/PATCH/DELETE endpoints [TaskTools.create_task_tool()](src/lunatask_mcp/tools/tasks.py:268), [TaskTools.update_task_tool()](src/lunatask_mcp/tools/tasks.py:414), [TaskTools.delete_task_tool()](src/lunatask_mcp/tools/tasks.py:607)
- [x] Task 4: Return structured MCP errors when rate-limited (AC: 3)
  - [x] Subtask 4.1: Map HTTP 429 to domain error [LunaTaskRateLimitError()](src/lunatask_mcp/api/exceptions.py:125) in client handler [LunaTaskClient._handle_http_error()](src/lunatask_mcp/api/client.py:179)
  - [x] Subtask 4.2: Resources log ctx.error and re-raise typed errors [TaskTools.get_tasks_resource()](src/lunatask_mcp/tools/tasks.py:125), [TaskTools.get_task_resource()](src/lunatask_mcp/tools/tasks.py:225)
  - [x] Subtask 4.3: Tools return structured JSON error payloads with error="rate_limit_error" [TaskTools.create_task_tool()](src/lunatask_mcp/tools/tasks.py:363), [TaskTools.update_task_tool()](src/lunatask_mcp/tools/tasks.py:556), [TaskTools.delete_task_tool()](src/lunatask_mcp/tools/tasks.py:693)
- [x] Task 5: Comprehensive testing with TDD (AC: 1–3)
  - [x] Subtask 5.1: Unit tests for limiter burst, steady-state, concurrency [tests/test_rate_limiting.py](tests/test_rate_limiting.py)
  - [x] Subtask 5.2: Client integration tests confirm await acquire before request [tests/test_api_client.py](tests/test_api_client.py)
  - [x] Subtask 5.3: MCP-level resource/tool tests validate ctx.error and structured error responses [tests/test_task_tools.py](tests/test_task_tools.py)

## Dev Notes

### Previous Story Insights
- Rate limiting was anticipated and referenced in earlier stories; client and TaskTools integration patterns established in [Story 2.1](docs/stories/2.1.story.md) through [Story 2.5](docs/stories/2.5.story.md)

### Architecture and Design
- Algorithm: Token bucket with continuous refill at rpm/60 seconds, burst-cap tracking, async lock guarding critical sections [TokenBucketLimiter._refill_tokens()](src/lunatask_mcp/rate_limiter.py:96)
- Configurability: Bounds enforced via Pydantic Field constraints and runtime checks [ServerConfig.rate_limit_rpm](src/lunatask_mcp/config.py:51), [ServerConfig.rate_limit_burst](src/lunatask_mcp/config.py:58), [TokenBucketLimiter.__init__()](src/lunatask_mcp/rate_limiter.py:35)
- Integration: Single enforcement point in client ensures all HTTP verbs respect limits [LunaTaskClient.make_request()](src/lunatask_mcp/api/client.py:225)
- Scope: Limiter is per-client instance; multiple clients have independent quotas (validated by tests) [tests/test_api_client.py](tests/test_api_client.py)

### Error Handling Pattern
- HTTP 429 mapped to [LunaTaskRateLimitError()](src/lunatask_mcp/api/exceptions.py:125) in [LunaTaskClient._handle_http_error()](src/lunatask_mcp/api/client.py:179)
- Resources: emit `ctx.error` with user guidance and re-raise typed exceptions for MCP clients to structure [TaskTools.get_tasks_resource()](src/lunatask_mcp/tools/tasks.py:131), [TaskTools.get_task_resource()](src/lunatask_mcp/tools/tasks.py:225)
- Tools: return JSON with error codes aligned to MCP conventions ("rate_limit_error", etc.) [TaskTools.create_task_tool()](src/lunatask_mcp/tools/tasks.py:363)

### FastMCP Integration Notes
- Resource and tool behaviors align with FastMCP patterns: decorators for registration; ctx.info/ctx.error for client-visible logging; structured return payloads for tools [TaskTools._register_resources()](src/lunatask_mcp/tools/tasks.py:50)

### Configuration Summary
- Server configuration fields:
  - RPM: [ServerConfig.rate_limit_rpm](src/lunatask_mcp/config.py:51) (ge=1, le=10000)
  - Burst: [ServerConfig.rate_limit_burst](src/lunatask_mcp/config.py:58) (ge=1, le=100)

### Open Considerations (Non-blocking)
- Retry-After: LunaTask API docs found via research do not specify a Retry-After header contract for 429. Optional future enhancement: read and honor Retry-After if introduced, logging guidance for clients [LunaTaskClient._handle_http_error()](src/lunatask_mcp/api/client.py:144)
- Observability: Optional debug logs using [TokenBucketLimiter.current_tokens](src/lunatask_mcp/rate_limiter.py:112) during troubleshooting
- Process scope: In-memory limiter is per-process; multi-process deployments will enforce limits per process (acceptable per AC)

## File Locations
- Rate limiter implementation: [src/lunatask_mcp/rate_limiter.py](src/lunatask_mcp/rate_limiter.py)
- Client integration: [src/lunatask_mcp/api/client.py](src/lunatask_mcp/api/client.py)
- Task tools: [src/lunatask_mcp/tools/tasks.py](src/lunatask_mcp/tools/tasks.py)
- Server configuration: [src/lunatask_mcp/config.py](src/lunatask_mcp/config.py)
- Tests: [tests/test_rate_limiting.py](tests/test_rate_limiting.py), [tests/test_api_client.py](tests/test_api_client.py), [tests/test_task_tools.py](tests/test_task_tools.py)

## Testing
- Methodology: TDD with async tests (pytest-asyncio), comprehensive unit + integration + MCP-level coverage
- Limiter unit tests: burst, steady-state, token exhaustion, concurrent fairness, high-RPM precision [tests/test_rate_limiting.py](tests/test_rate_limiting.py)
- Client integration tests: per-request awaiting, per-client independence [tests/test_api_client.py](tests/test_api_client.py)
- MCP behavior tests: ctx.error mapping, structured tool errors for 429 across create/update/delete flows [tests/test_task_tools.py](tests/test_task_tools.py)

## Dev Agent Record

### Agent Model Used
openai/gpt-5

### Debug Log References
- Limiter implementation validated via unit tests in [tests/test_rate_limiting.py](tests/test_rate_limiting.py)
- Client await pattern confirmed in [tests/test_api_client.py](tests/test_api_client.py)
- MCP error translation patterns confirmed in [tests/test_task_tools.py](tests/test_task_tools.py)

### Completion Notes
- In-memory token bucket limiter implemented with async lock and accurate time-based refill
- Centralized enforcement ensures zero missed call sites across resources/tools
- Structured MCP error responses established and verified for rate-limited conditions
- Configuration validated at both schema (Pydantic Field constraints) and runtime (constructor guards)

### File List
- Implemented/Used: [src/lunatask_mcp/rate_limiter.py](src/lunatask_mcp/rate_limiter.py), [src/lunatask_mcp/api/client.py](src/lunatask_mcp/api/client.py), [src/lunatask_mcp/tools/tasks.py](src/lunatask_mcp/tools/tasks.py), [src/lunatask_mcp/config.py](src/lunatask_mcp/config.py)
- Tests: [tests/test_rate_limiting.py](tests/test_rate_limiting.py), [tests/test_api_client.py](tests/test_api_client.py), [tests/test_task_tools.py](tests/test_task_tools.py)

## QA Results

### Review Date: 2025-08-23

### Reviewed By: Quinn (Senior Developer QA)

### Code Quality Assessment
- Clean, centralized rate limiting via client-level await pattern [LunaTaskClient.make_request()](src/lunatask_mcp/api/client.py:225)
- Robust limiter implementation with concurrency safety and precise timing [TokenBucketLimiter.acquire()](src/lunatask_mcp/rate_limiter.py:52)
- Strong configuration validation and safe logging practices across layers

### Refactoring Performed
- N/A — design is clean; no refactoring required

### Compliance Check
- Coding Standards: ✓ Type hints, Google docstrings, <=100 cols, async/await, stderr logging
- Project Structure: ✓ Files in expected locations per architecture docs
- Testing Strategy: ✓ TDD across unit/integration/MCP behavioral tests
- All ACs Met: ✓ AC 1–3 fully implemented and validated

### Improvements Checklist
- [ ] Optional: Parse Retry-After if provided by upstream and emit guidance
- [ ] Optional: Add debug-level metrics for limiter state sampling during diagnostics

### Security Review
- No token exposure in logs; redaction verified
- Rate limiting reduces risk of API abuse/ban scenarios

### Performance Considerations
- Minimal overhead per call; accurate pacing after burst
- Per-client independence supports multi-tenant scenarios

### Final Status
**✓ Approved - Ready for Done** (Implementation already present and validated by tests)

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-23 | 1.0 | Initial story creation based on repository implementation and research synthesis | Bob (Scrum Master) |