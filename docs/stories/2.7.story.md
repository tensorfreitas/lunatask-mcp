# Story 2.7: Enforce and Validate Task Attribute Domains

## Status
Draft

## Story
**As a** developer,  
**I want** strict request-side validation and sensible defaults for core task attributes across MCP tools,  
**so that** only valid states are sent to LunaTask while maintaining compatibility with upstream responses.

## Acceptance Criteria
1. Request-side validation for TaskCreate and TaskUpdate:
   - status: must be one of {"later", "next", "started", "waiting", "completed"}; default "later" on create.
   - priority: integer in [-2, -1, 0, 1, 2]; default 0 on create.
   - motivation: one of {"must", "should", "want", "unknown"}; default "unknown" on create.
   - eisenhower: integer in [0, 1, 2, 3, 4] (0 = Uncategorized).
2. TaskCreate and TaskUpdate include optional motivation and eisenhower fields (validated when present); MCP tools accept and forward these fields.
3. Response handling is compatibility-first (permissive): TaskResponse accepts upstream values without normalization or rejection (e.g., "open" is passed through).
4. create_task and update_task return structured MCP errors on validation failures that clearly indicate the invalid field and allowed values.
5. Attribute evaluation tests cover presence/optionality and types for:
   - id, area_id, goal_id, status, previous_status, estimate, priority, progress, motivation, eisenhower, source, scheduled_on, completed_at, created_at, updated_at.
6. Boundary tests:
   - priority accepts -2 and 2; rejects < -2 or > 2 on requests.
   - eisenhower accepts 0 and 4; rejects < 0 or > 4 on requests.
   - status accepts only the 5 allowed values; motivation accepts only the 4 allowed values.
7. No cross-field invariants (e.g., completed ⇒ completed_at) are enforced in this story.
8. No changes to rate limiting or encryption handling.

Source: [epic-2-full-task-api-integration.md](docs/prd/epic-2-full-task-api-integration.md:52)

## TDD Methodology Enforcement
This story MUST be executed strictly with TDD per [11-coding-standards.md](docs/architecture/11-coding-standards.md:36):

For each AC and change:
1) Write the failing test(s) first  
2) Run and observe failures  
3) Implement the minimal code to pass  
4) Refactor while keeping tests green  
5) Repeat

## Tasks / Subtasks (Strict TDD Order)

- [ ] Task 1: Model validation and defaults in request models (AC: 1, 2, 3)
  - [ ] Tests first (fail expected) in [tests/test_api_client.py](tests/test_api_client.py)
    - [ ] Defaults on create: status="later", priority=0, motivation="unknown"
    - [ ] status enum allowed set: {"later","next","started","waiting","completed"}
    - [ ] motivation enum allowed set: {"must","should","want","unknown"}
    - [ ] priority bounds: accept -2 and 2; reject < -2 or > 2
    - [ ] eisenhower bounds: accept 0 and 4; reject < 0 or > 4
    - [ ] TaskResponse remains permissive: accepts upstream "open" etc. without normalization
  - [ ] Implement minimal changes in [src/lunatask_mcp/api/models.py](src/lunatask_mcp/api/models.py)
    - [ ] Update request models [TaskCreate()](docs/architecture/4-data-models.md:86) and [TaskUpdate()](docs/architecture/4-data-models.md:104) to:
      - Add optional fields motivation and eisenhower
      - Enforce enums/ranges via Pydantic validation (create defaults only in TaskCreate)
    - [ ] Ensure response model [TaskResponse()](docs/architecture/4-data-models.md:22) remains permissive (no normalization)
  - [ ] Refactor: keep type hints and docstrings per standards, no behavior change

- [ ] Task 2: MCP tool parameter schemas and error translation (AC: 2, 4)
  - [ ] Tests first (fail expected) in [tests/test_task_tools.py](tests/test_task_tools.py)
    - [ ] create_task tool accepts and forwards motivation, eisenhower (valid cases)
    - [ ] update_task tool accepts and forwards motivation, eisenhower (valid cases)
    - [ ] Invalid enums/ranges produce structured MCP errors indicating field and allowed values
  - [ ] Implement minimal changes in [src/lunatask_mcp/tools/tasks.py](src/lunatask_mcp/tools/tasks.py)
    - [ ] Extend tool input schemas for create/update to include motivation, eisenhower
    - [ ] Map model validation errors to structured MCP error payloads (preserve existing patterns)
  - [ ] Refactor: unify error formatting across tools

- [ ] Task 3: Documentation and architecture alignment (AC: 3)
  - [ ] Verify no changes required to rate limiting; it remains enforced centrally (see [6-external-apis.md](docs/architecture/6-external-apis.md:74))
  - [ ] Confirm component boundaries stay intact per [5-components.md](docs/architecture/5-components.md:5)
  - [ ] Update README if needed; keep docs consistent with model/tool behavior

## Dev Notes

### Previous Story Insights
- Rate limiting exists and is enforced at the client layer; unchanged in this story. See [2.6.story.md](docs/stories/2.6.story.md:81) Dev Agent Record and notes; architecture confirms limiter application [6-external-apis.md](docs/architecture/6-external-apis.md:74).
- Structured MCP error translation patterns are already established in tools; reuse same formatting in [src/lunatask_mcp/tools/tasks.py](src/lunatask_mcp/tools/tasks.py).

### Data Models
- Request models to adjust: [TaskCreate()](docs/architecture/4-data-models.md:86), [TaskUpdate()](docs/architecture/4-data-models.md:104).
- Response model remains permissive by design: [TaskResponse()](docs/architecture/4-data-models.md:22) includes motivation and eisenhower fields; do not normalize values.

### Architecture and Components
- No new endpoints; tools remain mapped to Tasks API per [6-external-apis.md](docs/architecture/6-external-apis.md:18).
- Responsibilities unchanged per [5-components.md](docs/architecture/5-components.md:5).

### File Locations
- Request/response models: [src/lunatask_mcp/api/models.py](src/lunatask_mcp/api/models.py)
- Tools: [src/lunatask_mcp/tools/tasks.py](src/lunatask_mcp/tools/tasks.py)
- Tests: [tests/test_api_client.py](tests/test_api_client.py), [tests/test_task_tools.py](tests/test_task_tools.py)
- Source tree guidance: [8-source-tree.md](docs/architecture/8-source-tree.md:1)

## Testing

### TDD-Centric Test Matrices

- Model Defaults and Validation (in [tests/test_api_client.py](tests/test_api_client.py))
  - Defaults (TaskCreate):
    - status → "later"
    - priority → 0
    - motivation → "unknown"
  - Enums:
    - status ∈ {"later","next","started","waiting","completed"}
    - motivation ∈ {"must","should","want","unknown"}
  - Ranges:
    - priority ∈ [-2..2], boundaries accepted, outside rejected
    - eisenhower ∈ [0..4], boundaries accepted, outside rejected
  - Permissive Response Handling:
    - [TaskResponse()](docs/architecture/4-data-models.md:22) accepts upstream values like "open" without normalization

- Tool Parameters and Error Translation (in [tests/test_task_tools.py](tests/test_task_tools.py))
  - create_task tool:
    - Accepts motivation/eisenhower; forwards to client
    - Invalid enums/ranges → structured MCP error with field and allowed values
  - update_task tool:
    - Accepts motivation/eisenhower; forwards to client
    - Invalid enums/ranges → structured MCP error with field and allowed values

### Non-Goals for Testing
- No rate limiting behavior changes (covered previously; see [2.6.story.md](docs/stories/2.6.story.md:1))
- No encryption behavior changes (responses remain permissive)

## Technical Constraints
- Python 3.12, full type hints, Google docstrings, ≤100 columns, async I/O only, secure logging to stderr; per [11-coding-standards.md](docs/architecture/11-coding-standards.md:12).

## Dev Agent Record

### Agent Model Used
- Pending

### Debug Log References
- Pending

### Completion Notes
- Pending

### File List
- Pending

## Change Log
| Date       | Version | Description                                                              | Author            |
|------------|---------|--------------------------------------------------------------------------|-------------------|
| 2025-08-26 | 0.2     | TDD-first draft with explicit test matrices and strict TDD ordering     | Bob (Scrum Master) |
| 2025-08-26 | 0.1     | Initial draft created from PRD AC and architecture references           | Bob (Scrum Master) |