# Story 3.1: Track Habit Tool

## Status
Ready for implementation

## Story
**As a** user,  
**I want** to track an activity for a specific habit on a given date using an MCP tool,  
**so that** I can log my habit progress from my AI tools.

## Acceptance Criteria
1. An MCP `tool` named `track_habit` is implemented.
2. The tool accepts a habit `id` and a `date` as parameters.
3. When called, the tool makes an authenticated `POST` request to the `https://api.lunatask.app/v1/habits/<id>/track` endpoint.
4. The body of the POST request includes the date as `performed_on` in ISO-8601 format (`YYYY-MM-DD`).
5. A successful API call results in a successful MCP response.
6. The tool handles error responses correctly (e.g., habit not found).
7. The rate limiter from Epic 2 is applied to this tool.

## Epic 2 Dependencies
- **Rate Limiter Status**: ✅ **IMPLEMENTED** - `TokenBucketLimiter` is active in `LunaTaskClient.make_request()` (confirmed via source code inspection)

## TDD Methodology Enforcement
All work MUST follow strict TDD per project standards: write failing tests first, run and observe failures, implement the minimal code to pass, refactor while keeping tests green, repeat. [Source: architecture/11-coding-standards.md#testing-strategy]

## Tasks / Subtasks
- [ ] Task 1: Define client capability (AC: 3, 4, 5, 6, 7)
  - [ ] Tests first in `tests/test_api_client_track_habit.py`:
    - [ ] Success path: `LunaTaskClient.track_habit(habit_id, date)` issues `POST /v1/habits/{id}/track` with JSON `{"performed_on": "YYYY-MM-DD"}` and Authorization header; returns `None` transparently. (AC: 3–5)
    - [ ] Error mapping: 401→`LunaTaskAuthenticationError`, 404→`LunaTaskNotFoundError`, 422→`LunaTaskValidationError`, 429→`LunaTaskRateLimitError`, 5xx→`LunaTaskServerError`, timeout/network→`LunaTaskTimeoutError`/`LunaTaskNetworkError`. (AC: 6) [Source: architecture/10-error-handling-strategy.md#general-approach]
    - [ ] Rate limiter invoked before request (integration via `make_request`). (AC: 7)
  - [ ] Implement `LunaTaskClient.track_habit(habit_id: str, date: date) -> None` calling `make_request("POST", f"habits/{habit_id}/track", data={"performed_on": date.isoformat()})`. Reuse existing headers and limiter. (AC: 3, 4, 7)

- [ ] Task 2: Implement MCP tool (AC: 1–6)
  - [ ] Tests first in `tests/test_habit_tools_track_tool.py`:
    - [ ] Tool registration: `track_habit` is registered by HabitTools. (AC: 1)
    - [ ] Parameter schema: requires `id: str`, `date: str (ISO YYYY-MM-DD)`. (AC: 2)
    - [ ] Success path delegates to client and returns success payload (e.g., `{ "ok": true }`). (AC: 5)
    - [ ] Error translation: custom exceptions mapped to structured MCP errors; logs to stderr only; token never logged. (AC: 6) [Source: architecture/10-error-handling-strategy.md#tool-layer-translation]
  - [ ] Create `src/lunatask_mcp/tools/habits.py` with `HabitTools` delegator mirroring `TaskTools` pattern; register tool `track_habit` that injects `LunaTaskClient` and calls `track_habit`. (AC: 1–6) [Source: architecture/5-components.md#3-habittools-mcp-interface-component]
  - [ ] Wire-up in `src/lunatask_mcp/main.py` (CoreServer class) to register `HabitTools` alongside `TaskTools`. (AC: 1)

- [ ] Task 3: Data model alignment and minimalism (AC: 4)
  - [ ] **VALIDATED**: LunaTask API expects only `performed_on` field in ISO-8601 format (`YYYY-MM-DD`) - confirmed via API documentation. (YAGNI) [Source: architecture/11-coding-standards.md#design-principles]
  - [ ] Send minimal payload `{ "performed_on": "YYYY-MM-DD" }` directly. Future `HabitTrackRequest` model can be added in later stories if needed. [Source: architecture/4-data-models.md#habit-models]

- [ ] Task 4: Documentation updates
  - [ ] Ensure `docs/architecture/6-external-apis.md` references are consistent with implementation notes (no changes expected). [Source: architecture/6-external-apis.md#lunatask-api]
  - [ ] README: add brief usage example for `track_habit` tool only if required by Epic 3.2; otherwise defer to that story.

## Dev Notes

### Technical Constraints
- All I/O and network calls are asynchronous (`async/await`) and must use `httpx` with the existing client plumbing. [Source: architecture/3-tech-stack.md#technology-stack-table]
- Log to `stderr` only; never use `print()`. Do not include bearer tokens in any logs or exceptions. [Source: architecture/11-coding-standards.md#critical-rules-for-ai-agents]
- Use custom exceptions defined for API error mapping; tools translate these to structured MCP errors. [Source: architecture/10-error-handling-strategy.md#general-approach]
- Maintain explicit type hints for all new functions and parameters. [Source: architecture/11-coding-standards.md#core-standards]

### External API
- Base URL: `https://api.lunatask.app/v1/`; authentication via `Authorization: Bearer <token>`. [Source: architecture/6-external-apis.md#lunatask-api]
- Habit tracking endpoint: `POST /v1/habits/{id}/track` with JSON body `{"performed_on": "YYYY-MM-DD"}` in ISO-8601 format. [Validated: LunaTask API Documentation]
- Rate limiting: `TokenBucketLimiter` integrated in `LunaTaskClient.make_request()` - **already implemented and active**.
- Rate limits are undocumented; apply a conservative, configurable rate limiter (already implemented as `TokenBucketLimiter` and used in `make_request`). [Source: architecture/6-external-apis.md#lunatask-api]

### Components & File Locations
- Service client method: add `track_habit` to `LunaTaskClient` (API component). [Source: architecture/5-components.md#1-lunataskclient-service-component]
- MCP tool: add `HabitTools` with `track_habit` registration in `src/lunatask_mcp/tools/habits.py`; mirror the delegator+handler pattern used by Task tools. [Source: architecture/5-components.md#3-habittools-mcp-interface-component]
- Server registration: register `HabitTools` in `CoreServer._register_tools()` so the tool is available at runtime. [Source: architecture/5-components.md#4-coreserver-application-runner]
- Source tree alignment for new files follows the documented structure. [Source: architecture/8-source-tree.md#8-source-tree]

### Data Models
- **CORRECTED**: API expects `performed_on` field, not `date`. Minimal request: `{ "performed_on": "YYYY-MM-DD" }` sent directly.
- Future `HabitTrackRequest` model can be added when more fields are needed; keep YAGNI for this story. [Source: architecture/4-data-models.md#habit-models]

### Testing
- Follow strict TDD: tests first, then minimal implementation. [Source: architecture/11-coding-standards.md#testing-strategy]
- Use `pytest` and `pytest-asyncio` for async tests; keep tests under 500 lines and split by concern. [Source: architecture/11-coding-standards.md#test-organization-and-conventions]
- Assert that logging is to `stderr` and that tokens never appear in logs. [Source: architecture/11-coding-standards.md#critical-rules-for-ai-agents]

### Project Structure Notes
- New module `tools/habits.py` and the addition in `main.py` must conform to the delegator + dependency injection pattern used by `TaskTools`. [Source: architecture/5-components.md#2-tasktools-mcp-interface-component]

## Dev Agent Record
### Agent Model Used
_To be completed by Dev Agent_

### Debug Log References
_To be completed by Dev Agent_

### Completion Notes List
_To be completed by Dev Agent_

### File List
_To be completed by Dev Agent_

## QA Results
_To be completed by QA Agent_

## Change Log
| Date       | Version | Description                        | Author |
| ---------- | ------- | ---------------------------------- | ------ |
| 2025-09-06 | 0.1     | Initial draft of Story 3.1 created | SM     |
| 2025-09-06 | 1.0     | Applied critical fixes: validated rate limiter dependency, corrected API payload format to `performed_on`, fixed file path references. Status: Draft → Approved | Sarah (PO) |
